```python
%matplotlib inline
import math
import re
import numpy as np
import pandas as pd
import scipy.stats as stats
import matplotlib.pyplot as plt
import matplotlib.pyplot as plt
import seaborn as sns
import re

from collections import defaultdict
from scipy.stats import pearsonr
import pandas as pd
from IPython.display import display

```


```python
DATA_DIR = r"Y:\Studium\3. Sem UniPI\Data Analytics 4 digital Health\Data"

DATASETS = {
    "heart_diagnoses_1": "heart_diagnoses_1.csv",
    "laboratory_events_codes_2": "laboratory_events_codes_2.csv",
    "microbiology_events_codes_3": "microbiology_events_codes_3.csv",
    "procedure_code_4": "procedure_code_4.csv",
}
name = "laboratory_events_codes_2"
```


```python
df = pd.read_csv(f"{DATA_DIR}/{DATASETS[name]}", index_col=False)

df.columns
```




    Index(['hadm_id', 'charttime', 'value', 'valuenum', 'valueuom',
           'ref_range_lower', 'ref_range_upper', 'flag', 'label', 'fluid',
           'examination_group', 'analysis_batch_id', 'qc_flag', 'ref_range'],
          dtype='object')



# INspections

## A


```python
df.head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hadm_id</th>
      <th>charttime</th>
      <th>value</th>
      <th>valuenum</th>
      <th>valueuom</th>
      <th>ref_range_lower</th>
      <th>ref_range_upper</th>
      <th>flag</th>
      <th>label</th>
      <th>fluid</th>
      <th>examination_group</th>
      <th>analysis_batch_id</th>
      <th>qc_flag</th>
      <th>ref_range</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>29654838.0</td>
      <td>2188-01-04 23:43:00</td>
      <td>___</td>
      <td>198.00</td>
      <td>IU/L</td>
      <td>29.0</td>
      <td>201.00</td>
      <td>NaN</td>
      <td>Creatine Kinase (CK)</td>
      <td>Blood</td>
      <td>Cardiac Markers</td>
      <td>BATCH_218801_N3</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>29654838.0</td>
      <td>2188-01-04 23:43:00</td>
      <td>5</td>
      <td>5.00</td>
      <td>ng/mL</td>
      <td>0.0</td>
      <td>10.00</td>
      <td>NaN</td>
      <td>Creatine Kinase, MB Isoenzyme</td>
      <td>Blood</td>
      <td>Cardiac Markers</td>
      <td>BATCH_218801_C7</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>29654838.0</td>
      <td>2188-01-04 23:43:00</td>
      <td>___</td>
      <td>0.03</td>
      <td>ng/mL</td>
      <td>0.0</td>
      <td>0.01</td>
      <td>abnormal</td>
      <td>Troponin T</td>
      <td>Blood</td>
      <td>Cardiac Markers</td>
      <td>BATCH_218801_R4</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>1.2</td>
      <td>1.20</td>
      <td>NaN</td>
      <td>0.9</td>
      <td>1.10</td>
      <td>abnormal</td>
      <td>INR(PT)</td>
      <td>Blood</td>
      <td>Coagulation and Hemostasis</td>
      <td>BATCH_218801_K7</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>12.8</td>
      <td>12.80</td>
      <td>sec</td>
      <td>9.4</td>
      <td>12.50</td>
      <td>abnormal</td>
      <td>PT</td>
      <td>Blood</td>
      <td>Coagulation and Hemostasis</td>
      <td>BATCH_218801_B1</td>
      <td>WARN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>85.8</td>
      <td>85.80</td>
      <td>sec</td>
      <td>25.0</td>
      <td>36.50</td>
      <td>abnormal</td>
      <td>PTT</td>
      <td>Blood</td>
      <td>Coagulation and Hemostasis</td>
      <td>BATCH_218801_R1</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>___</td>
      <td>8.10</td>
      <td>%</td>
      <td>4.8</td>
      <td>5.90</td>
      <td>abnormal</td>
      <td>% Hemoglobin A1c</td>
      <td>Blood</td>
      <td>HbA1c</td>
      <td>BATCH_218801_O1</td>
      <td>OK</td>
      <td>Normal range: 70-110</td>
    </tr>
    <tr>
      <th>7</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>___</td>
      <td>186.00</td>
      <td>mg/dL</td>
      <td>91.0</td>
      <td>123.00</td>
      <td>abnormal</td>
      <td>eAG</td>
      <td>Blood</td>
      <td>HbA1c</td>
      <td>BATCH_218801_P4</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>19</td>
      <td>19.00</td>
      <td>mEq/L</td>
      <td>8.0</td>
      <td>20.00</td>
      <td>NaN</td>
      <td>Anion Gap</td>
      <td>Blood</td>
      <td>Renal Function Tests</td>
      <td>BATCH_218801_O5</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>20</td>
      <td>20.00</td>
      <td>mEq/L</td>
      <td>22.0</td>
      <td>32.00</td>
      <td>abnormal</td>
      <td>Bicarbonate</td>
      <td>Blood</td>
      <td>BMP</td>
      <td>BATCH_218801_A1</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.tail(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hadm_id</th>
      <th>charttime</th>
      <th>value</th>
      <th>valuenum</th>
      <th>valueuom</th>
      <th>ref_range_lower</th>
      <th>ref_range_upper</th>
      <th>flag</th>
      <th>label</th>
      <th>fluid</th>
      <th>examination_group</th>
      <th>analysis_batch_id</th>
      <th>qc_flag</th>
      <th>ref_range</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>978493</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>29.9</td>
      <td>29.90</td>
      <td>%</td>
      <td>34.0</td>
      <td>45.0</td>
      <td>abnormal</td>
      <td>Hematocrit</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_Y8</td>
      <td>OK</td>
      <td>Normal range: 70-110</td>
    </tr>
    <tr>
      <th>978494</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>9.9</td>
      <td>9.90</td>
      <td>g/dL</td>
      <td>11.2</td>
      <td>15.7</td>
      <td>abnormal</td>
      <td>Hemoglobin</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_D7</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>978495</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>30.4</td>
      <td>30.40</td>
      <td>pg</td>
      <td>26.0</td>
      <td>32.0</td>
      <td>NaN</td>
      <td>MCH</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_J8</td>
      <td>WARN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>978496</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>33.1</td>
      <td>33.10</td>
      <td>g/dL</td>
      <td>32.0</td>
      <td>37.0</td>
      <td>NaN</td>
      <td>MCHC</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_O5</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>978497</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>92</td>
      <td>92.00</td>
      <td>fL</td>
      <td>82.0</td>
      <td>98.0</td>
      <td>NaN</td>
      <td>MCV</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_M3</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>978498</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>180</td>
      <td>180.00</td>
      <td>K/uL</td>
      <td>150.0</td>
      <td>400.0</td>
      <td>NaN</td>
      <td>Platelet Count</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_B1</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>978499</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>14.5</td>
      <td>14.50</td>
      <td>%</td>
      <td>10.5</td>
      <td>15.5</td>
      <td>NaN</td>
      <td>RDW</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_H5</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>978500</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>3.26</td>
      <td>3.26</td>
      <td>m/uL</td>
      <td>3.9</td>
      <td>5.2</td>
      <td>abnormal</td>
      <td>Red Blood Cells</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_N7</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>978501</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>8.4</td>
      <td>8.40</td>
      <td>K/uL</td>
      <td>4.0</td>
      <td>10.0</td>
      <td>NaN</td>
      <td>White Blood Cells</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_Y6</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>978502</th>
      <td>21557581.0</td>
      <td>2145-08-02 08:30:00</td>
      <td>47.9</td>
      <td>47.90</td>
      <td>fL</td>
      <td>35.1</td>
      <td>46.3</td>
      <td>abnormal</td>
      <td>RDW-SD</td>
      <td>Blood</td>
      <td>Complete Blood Count (CBC)</td>
      <td>BATCH_214508_P9</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>



## B


```python
df.columns
```




    Index(['hadm_id', 'charttime', 'value', 'valuenum', 'valueuom',
           'ref_range_lower', 'ref_range_upper', 'flag', 'label', 'fluid',
           'examination_group', 'analysis_batch_id', 'qc_flag', 'ref_range'],
          dtype='object')




```python
df[df.columns[:10]].head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hadm_id</th>
      <th>charttime</th>
      <th>value</th>
      <th>valuenum</th>
      <th>valueuom</th>
      <th>ref_range_lower</th>
      <th>ref_range_upper</th>
      <th>flag</th>
      <th>label</th>
      <th>fluid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>29654838.0</td>
      <td>2188-01-04 23:43:00</td>
      <td>NaN</td>
      <td>198.00</td>
      <td>IU/L</td>
      <td>29.0</td>
      <td>201.00</td>
      <td>NaN</td>
      <td>Creatine Kinase (CK)</td>
      <td>Blood</td>
    </tr>
    <tr>
      <th>1</th>
      <td>29654838.0</td>
      <td>2188-01-04 23:43:00</td>
      <td>5.0</td>
      <td>5.00</td>
      <td>ng/mL</td>
      <td>0.0</td>
      <td>10.00</td>
      <td>NaN</td>
      <td>Creatine Kinase, MB Isoenzyme</td>
      <td>Blood</td>
    </tr>
    <tr>
      <th>2</th>
      <td>29654838.0</td>
      <td>2188-01-04 23:43:00</td>
      <td>NaN</td>
      <td>0.03</td>
      <td>ng/mL</td>
      <td>0.0</td>
      <td>0.01</td>
      <td>abnormal</td>
      <td>Troponin T</td>
      <td>Blood</td>
    </tr>
    <tr>
      <th>3</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>1.2</td>
      <td>1.20</td>
      <td>NaN</td>
      <td>0.9</td>
      <td>1.10</td>
      <td>abnormal</td>
      <td>INR(PT)</td>
      <td>Blood</td>
    </tr>
    <tr>
      <th>4</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>12.8</td>
      <td>12.80</td>
      <td>sec</td>
      <td>9.4</td>
      <td>12.50</td>
      <td>abnormal</td>
      <td>PT</td>
      <td>Blood</td>
    </tr>
    <tr>
      <th>5</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>85.8</td>
      <td>85.80</td>
      <td>sec</td>
      <td>25.0</td>
      <td>36.50</td>
      <td>abnormal</td>
      <td>PTT</td>
      <td>Blood</td>
    </tr>
    <tr>
      <th>6</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>NaN</td>
      <td>8.10</td>
      <td>%</td>
      <td>4.8</td>
      <td>5.90</td>
      <td>abnormal</td>
      <td>% Hemoglobin A1c</td>
      <td>Blood</td>
    </tr>
    <tr>
      <th>7</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>NaN</td>
      <td>186.00</td>
      <td>mg/dL</td>
      <td>91.0</td>
      <td>123.00</td>
      <td>abnormal</td>
      <td>eAG</td>
      <td>Blood</td>
    </tr>
    <tr>
      <th>8</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>19.0</td>
      <td>19.00</td>
      <td>mEq/L</td>
      <td>8.0</td>
      <td>20.00</td>
      <td>NaN</td>
      <td>Anion Gap</td>
      <td>Blood</td>
    </tr>
    <tr>
      <th>9</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>20.0</td>
      <td>20.00</td>
      <td>mEq/L</td>
      <td>22.0</td>
      <td>32.00</td>
      <td>abnormal</td>
      <td>Bicarbonate</td>
      <td>Blood</td>
    </tr>
  </tbody>
</table>
</div>




```python
df[df.columns[10:]].head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>examination_group</th>
      <th>analysis_batch_id</th>
      <th>qc_flag</th>
      <th>ref_range</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Cardiac Markers</td>
      <td>BATCH_218801_N3</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Cardiac Markers</td>
      <td>BATCH_218801_C7</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Cardiac Markers</td>
      <td>BATCH_218801_R4</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Coagulation and Hemostasis</td>
      <td>BATCH_218801_K7</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Coagulation and Hemostasis</td>
      <td>BATCH_218801_B1</td>
      <td>WARN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Coagulation and Hemostasis</td>
      <td>BATCH_218801_R1</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6</th>
      <td>HbA1c</td>
      <td>BATCH_218801_O1</td>
      <td>OK</td>
      <td>Normal range: 70-110</td>
    </tr>
    <tr>
      <th>7</th>
      <td>HbA1c</td>
      <td>BATCH_218801_P4</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Renal Function Tests</td>
      <td>BATCH_218801_O5</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>9</th>
      <td>BMP</td>
      <td>BATCH_218801_A1</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>



## C


```python
df.columns
```




    Index(['hadm_id', 'charttime', 'value', 'valuenum', 'valueuom',
           'ref_range_lower', 'ref_range_upper', 'flag', 'label', 'fluid',
           'examination_group', 'analysis_batch_id', 'qc_flag', 'ref_range'],
          dtype='object')




```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 978503 entries, 0 to 978502
    Data columns (total 14 columns):
     #   Column             Non-Null Count   Dtype  
    ---  ------             --------------   -----  
     0   hadm_id            978503 non-null  float64
     1   charttime          978503 non-null  object 
     2   value              934025 non-null  object 
     3   valuenum           907317 non-null  float64
     4   valueuom           884585 non-null  object 
     5   ref_range_lower    865544 non-null  float64
     6   ref_range_upper    865544 non-null  float64
     7   flag               343687 non-null  object 
     8   label              978503 non-null  object 
     9   fluid              978503 non-null  object 
     10  examination_group  978503 non-null  object 
     11  analysis_batch_id  978503 non-null  object 
     12  qc_flag            978503 non-null  object 
     13  ref_range          146215 non-null  object 
    dtypes: float64(4), object(10)
    memory usage: 104.5+ MB
    


```python
df[[ 'fluid', ]].value_counts()
```




    fluid              
    Blood                  1094521
    Urine                    68342
    Pleural                   2374
    Other Body Fluid          1890
    Ascites                    221
    Joint Fluid                182
    Cerebrospinal Fluid         36
    Stool                       15
    Bone Marrow                 14
    Name: count, dtype: int64




```python
df[[ 'label' ]].value_counts()
```




    label                   
    Glucose                     47041
    Potassium                   44226
    Sodium                      42886
    Chloride                    42762
    Creatinine                  41979
                                ...  
    CD16/56 Absolute Count          1
    Ammonium Biurate                1
    Bicarbonate, Other Fluid        1
    Urine Fat Bodies                1
    24 hr Calcium                   1
    Name: count, Length: 502, dtype: int64




```python
df[['examination_group',]].value_counts()
```




    examination_group         
    Complete Blood Count (CBC)    336296
    BMP                           328247
    Renal Function Tests          118612
    Blood Gas                     114048
    Coagulation and Hemostasis     72681
                                   ...  
    PAN2                               1
    Sodium, Body Fluid                 1
    Trichomonas vaginalis              1
    Triglycerides, Ascites             1
    Urea Nitrogen, Body Fluid          1
    Name: count, Length: 202, dtype: int64




```python
df[ 'fluid'].unique()
```




    array(['Blood', 'Urine', 'Other Body Fluid', 'Pleural', 'Ascites',
           'Cerebrospinal Fluid', 'Stool', 'Joint Fluid', 'Bone Marrow'],
          dtype=object)




```python
df[ 'label'].unique()
```




    array(['Creatine Kinase (CK)', 'Creatine Kinase, MB Isoenzyme',
           'Troponin T', 'INR(PT)', 'PT', 'PTT', '% Hemoglobin A1c', 'eAG',
           'Anion Gap', 'Bicarbonate', 'Calcium, Total', 'Chloride',
           'Cholesterol Ratio (Total/HDL)', 'Cholesterol, HDL',
           'Cholesterol, LDL, Calculated', 'Cholesterol, Total', 'Creatinine',
           'Glucose', 'Magnesium', 'Phosphate', 'Potassium', 'Sodium',
           'Triglycerides', 'Urea Nitrogen', 'Hematocrit', 'Hemoglobin',
           'MCH', 'MCHC', 'MCV', 'Platelet Count', 'RDW', 'Red Blood Cells',
           'White Blood Cells', 'Alanine Aminotransferase (ALT)',
           'Asparate Aminotransferase (AST)', 'Albumin',
           'Alkaline Phosphatase', 'Amylase', 'Bilirubin, Direct',
           'Bilirubin, Indirect', 'Bilirubin, Total', 'Vitamin B12',
           'Basophils', 'Eosinophils', 'Lymphocytes', 'Monocytes',
           'Neutrophils', 'EDTA Hold', 'Red Top Hold', 'CK-MB Index',
           'Thyroid Stimulating Hormone', 'Thyroxine (T4), Free',
           'Base Excess', 'Calculated Total CO2', 'Intubated',
           'Oxygen Saturation', 'pCO2', 'pH', 'pO2', 'Specimen Type',
           'Length of Urine Collection', 'Urine tube, held',
           'Estimated GFR (MDRD equation)', 'Osmolality, Measured',
           'Ferritin', 'Folate', 'Iron', 'Iron Binding Capacity, Total',
           'Transferrin', 'Creatinine, Urine', 'Osmolality, Urine',
           'Sodium, Urine', 'Urea Nitrogen, Urine',
           'Amphetamine Screen, Urine', 'Cocaine, Urine', 'Uhold', 'RDW-SD',
           'C-Reactive Protein', 'Cholesterol, LDL, Measured',
           'Sedimentation Rate', 'Green Top Hold (plasma)', 'tacroFK',
           'Bacteria', 'Bilirubin', 'Blood', 'Epithelial Cells',
           'Hyaline Casts', 'Ketone', 'Leukocytes', 'Nitrite', 'Protein',
           'RBC', 'Specific Gravity', 'Transitional Epithelial Cells',
           'Urine Appearance', 'Urine Color', 'Urine Mucous', 'Urobilinogen',
           'WBC', 'Yeast', 'H', 'I', 'L', 'Anti-Nuclear Antibody',
           'Protein Electrophoresis', 'Protein, Total', 'Free Kappa',
           'Free Kappa/Free Lambda Ratio', 'Free Lambda',
           'Immunofixation, Urine', 'Prot. Electrophoresis, Urine',
           'Protein/Creatinine Ratio', 'Total Protein, Urine',
           'Granular Casts', 'Chloride, Whole Blood', 'Free Calcium',
           'Hematocrit, Calculated', 'Lactate', 'Potassium, Whole Blood',
           'Sodium, Whole Blood', 'Ventilator', 'Fibrinogen, Functional',
           'Temperature', 'PEEP', 'Ventilation Rate', 'NTproBNP',
           'Absolute Lymphocyte Count', 'Absolute Basophil Count',
           'Absolute Eosinophil Count', 'Absolute Monocyte Count',
           'Absolute Neutrophil Count', 'Immature Granulocytes',
           'Blue Top Hold', 'D-Dimer', 'Light Green Top Hold',
           'Lactate Dehydrogenase (LD)', 'Assist/Control', 'Chloride, Urine',
           'Potassium, Urine', 'Platelet Smear', 'Lipase',
           'Amorphous Crystals', 'Digoxin', 'Vancomycin', 'Granulocyte Count',
           'Anisocytosis', 'Atypical Lymphocytes', 'Bands', 'Hypochromia',
           'Macrocytes', 'Metamyelocytes', 'Microcytes', 'Myelocytes',
           'Poikilocytosis', 'Polychromasia', 'Ovalocytes',
           'Barbiturate Screen, Urine', 'Benzodiazepine Screen, Urine',
           'Methadone, Urine', 'Opiate Screen, Urine', 'Voided Specimen',
           'Carboxyhemoglobin', 'Methemoglobin',
           'Hepatitis B Surface Antibody', 'Hepatitis B Surface Antigen',
           'Hepatitis B Virus Core Antibody', 'Hepatitis C Virus Antibody',
           'Cyclosporin', 'Oxygen', 'Uric Acid', 'Hematocrit, Other Fluid',
           'Monos', 'Polys', 'Total Nucleated Cells, Other',
           'Albumin, Body Fluid', 'Amylase, Body Fluid',
           'Glucose, Body Fluid', 'LD, Body Fluid',
           'Total Protein, Body Fluid', 'Nucleated Red Cells', 'Schistocytes',
           'Teardrop Cells', 'Echinocytes', 'Thyroxine (T4)',
           'Uric Acid, Urine', 'Haptoglobin', 'Reticulocyte Count, Automated',
           'Tidal Volume', 'Acanthocytes', 'Basophilic Stippling',
           'Target Cells', '24 hr Creatinine', '24 hr Protein',
           'Urine Volume', 'Bite Cells', 'Alveolar-arterial Gradient',
           'Required O2', 'Triiodothyronine (T3)', 'ARCH-1', 'HIV Screen',
           'Large Platelets', 'Fibrin Degradation Products', 'Globulin',
           'Macrophages', 'Mesothelial Cells', 'RBC, Pleural',
           'Total Nucleated Cells, Pleural', 'Albumin, Pleural',
           'Lactate Dehydrogenase, Pleural', 'Total Protein, Pleural',
           'Acetaminophen', 'Barbiturate Screen', 'Benzodiazepine Screen',
           'Salicylate', 'Tricyclic Antidepressant Screen',
           'Problem Specimen', 'O2 Flow', 'H/O Smear', 'Influenza A by PCR',
           'Influenza B by PCR', 'Albumin, Urine',
           'Albumin/Creatinine, Urine', 'Reticulocyte Count, Absolute',
           'Immunofixation', 'Immunoglobulin A', 'Immunoglobulin G',
           'Immunoglobulin M', 'WBC Clumps', 'Ammonia',
           'Beta-2 Microglobulin', 'C3', 'C4', 'Cortisol',
           'Gamma Glutamyltransferase', 'Cholesterol, Pleural',
           'Glucose, Pleural', 'Miscellaneous, Pleural', 'Albumin, Ascites',
           'Macrophage', 'Mesothelial Cell', 'RBC, Ascites',
           'Total Nucleated Cells, Ascites', 'Amylase, Pleural',
           'Hematocrit, Pleural', 'Phosphate, Urine', 'Alpha-Fetoprotein',
           'Human Chorionic Gonadotropin', 'CD10', 'CD19', 'CD20', 'CD45',
           'CD5', 'Immunophenotyping', 'Kappa', 'Lambda', 'Anat Path Hold',
           'Fragmented Cells', 'Triglycerides, Pleural', 'Rheumatoid Factor',
           'Reticulocyte Count, Manual', 'Anti-Mitochondrial Antibody',
           'Anti-Smooth Muscle Antibody', 'Urine Casts, Other',
           'Bicarbonate, Urine', 'Valproic Acid', 'Creatinine, Pleural',
           'Other', 'Anti-Neutrophil Cytoplasmic Antibody',
           'Anti-Nuclear Antibody, Titer', 'ANCA Titer', 'Uric Acid Crystals',
           'Calculated Bicarbonate, Whole Blood',
           'Hepatitis B Core Antibody, IgM', 'Prostate Specific Antigen',
           'Ethanol', 'Hepatitis C Viral Load', 'HPE7', 'HPE8', 'STX1',
           'STX2', 'STX3', 'STX4', 'STX5', 'STX6', 'Oxycodone', 'UTX1',
           'UTX2', 'UTX3', 'UTX4', 'UTX5', 'UTX6', 'UTX7',
           'Hepatitis A Virus Antibody', 'Hepatitis A Virus IgM Antibody',
           'DHEA-Sulfate', 'CA-125', 'Carcinoembyronic Antigen (CEA)',
           'Inpatient Hematology/Oncology Smear', 'HPE1',
           'Miscellaneous, Body Fluid', 'Lupus Anticoagulant',
           '25-OH Vitamin D', 'Parathyroid Hormone', 'Double Stranded DNA',
           'Cryoglobulin', 'Anticardiolipin Antibody IgG',
           'Anticardiolipin Antibody IgM', 'RBC, Other Fluid', 'Glucose, CSF',
           'Total Protein, CSF', 'Lymphs', 'RBC, CSF',
           'Total Nucleated Cells, CSF', 'Renal Epithelial Cells',
           'Phenytoin', 'Tissue Transglutaminase Ab, IgA', 'Heparin, LMW',
           'Spherocytes', 'Blood, Occult', 'Other Cell', 'HPE2', 'HPE3',
           'Thyroid Peroxidase Antibodies', 'Calculated TBG',
           'Calculated Thyroxine (T4) Index', 'Uptake Ratio',
           'Urine Specimen Type', 'HPE4', 'Cytomegalovirus Viral Load',
           'Joint Crystals, Birefringence', 'Joint Crystals, Comment',
           'Joint Crystals, Location', 'Joint Crystals, Number',
           'Joint Crystals, Shape', 'RBC, Joint Fluid',
           'Total Nucleated Cells, Joint', 'HIV 1 Viral Load',
           'Promyelocytes', 'Elliptocytes', 'Pencil Cells', 'Sickle Cells',
           'CD16/56', 'CD2', 'CD23', 'CD3', 'CD4', 'CD7', 'CD8', 'FMC-7',
           'HLA-DR', 'RBC Casts', 'Blood Parasite Smear', 'Hemoglobin A2',
           'Hemoglobin C', 'Hemogloblin A', 'Hemogloblin S',
           'HCG, Urine, Qualitative', 'EE1', 'EE2', 'EE6', '24 hr Calcium',
           'Calcium, Urine', 'Acetone', 'Gentamicin', 'Absolute CD3 Count',
           'Absolute CD4 Count', 'Absolute CD8 Count', 'CD3 Cells, Percent',
           'CD4 Cells, Percent', 'CD4/CD8 Ratio', 'CD8 Cells, Percent',
           'Lymphocytes, Percent', 'WBC Count',
           'Anti-Thyroglobulin Antibodies', 'Thyroglobulin',
           'Protein C, Functional', 'Protein S, Functional', 'Urine Comments',
           'Quantitative G6PD', 'Thrombin', 'Heparin', 'Blasts',
           'Howell-Jolly Bodies', 'Other Cells', 'Mesothelial cells',
           'Lithium', 'Plasma Cells', 'Calcium Oxalate Crystals',
           'proBNP, Pleural', 'Hematocrit, Joint Fluid', 'Serum Viscosity',
           'Myoglobin, Urine', 'Ammonium Biurate', 'Magnesium, Urine',
           'Urine Crystals, Other', 'Centromere', 'Hemoglobin F',
           'Antithrombin', 'Protein C, Antigen', 'Protein S, Antigen',
           'Factor VIII', 'Von Willebrand Factor Activity',
           'Von Willebrand Factor Antigen', 'Eosinophil Count',
           'Gray Top Hold (plasma)', 'Pappenheimer Bodies', 'Tobramycin',
           'Creatinine, Whole Blood', 'RBC Morphology', 'Rapamycin',
           'Hemosiderin', 'CD13', 'CD34', 'Factor V', 'Glucose, Ascites',
           'Lactate Dehydrogenase, Ascites', 'Total Protein, Ascites',
           'Plasma', 'NRBC', 'WBC Casts', 'Chlamydia trachomatis',
           'Neisseria gonorrhoeae', 'PAN1', 'Trichomonas vaginalis', 'PAN2',
           'Amylase, Ascites', 'CD3 %', 'CD3 Absolute Count', 'CD5 %',
           'CD5 Absolute Count', 'Inhibitor Screen', 'HPE6',
           'Norovirus Genogroup I', 'Norovirus Genogroup II', 'RFXLDLM',
           'CD16/56 Absolute Count', 'CD16/56%', 'CD19 %',
           'CD19 Absolute Count', 'CD20 %', 'CD20 Absolute Count',
           'Platelet Clumps', 'Bilirubin, Total, Ascites',
           'Bilirubin, Total, Pleural', 'Cellular Cast',
           'HIV 1 Ab Confirmation', 'HIV 2 Ab Confirmation',
           'Creatinine, Ascites', 'Reducing Substances, Urine',
           'MacroOvalocytes', 'Factor II', 'Factor VII', 'Factor X',
           'Hepatitis B Viral Load', 'Ethanol, Urine', 'Envelope Cells',
           'HIT-Ab Interpreted Result', 'HIT-Ab Numerical Result',
           'G6PD, Qualitative', 'EE7', 'Broad Casts',
           'Triglycerides, Ascites', 'EE3', 'EE5', 'HPE5', 'Urine Fat Bodies',
           'Blue Top Hold Frozen', 'Phenytoin, Free',
           'Phenytoin, Percent Free', 'ADP', 'Arachadonic Acid', 'Collagen',
           'Epinepherine', 'Phenobarbital', 'Cancer Antigen 27.29',
           'Triple Phosphate Crystals', 'Bicarbonate, Other Fluid',
           'Calcium, Body Fluid', 'Chloride, Body Fluid',
           'Creatinine, Body Fluid', 'Phosphate, Body Fluid',
           'Potassium, Body Fluid', 'Sodium, Body Fluid',
           'Urea Nitrogen, Body Fluid', 'Methotrexate', 'Waxy Casts',
           'NonSquamous Epithelial Cell', 'CD117', 'CD14', 'CD15', 'CD33',
           'CD56', 'CD64', 'LUC', 'Non-squamous Epithelial Cells', 'Sperm',
           'Glucose, Urine', 'Triglycer', 'Homocysteine', 'Young Cells',
           'Miscellaneous, Ascites', 'Hematocrit, Ascites'], dtype=object)



# Data Understanding and Preprocessing, cleaning of lab


```python
df.duplicated().sum()
```




    np.int64(2)




```python
#show duplicated rows
df[df.duplicated(keep=False)].sort_values(by=df.columns.tolist()).head(20)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hadm_id</th>
      <th>charttime</th>
      <th>value</th>
      <th>valuenum</th>
      <th>valueuom</th>
      <th>ref_range_lower</th>
      <th>ref_range_upper</th>
      <th>flag</th>
      <th>label</th>
      <th>fluid</th>
      <th>examination_group</th>
      <th>analysis_batch_id</th>
      <th>qc_flag</th>
      <th>ref_range</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>337781</th>
      <td>22665778.0</td>
      <td>2114-06-25 17:44:00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Length of Urine Collection</td>
      <td>Urine</td>
      <td>Urine Test</td>
      <td>BATCH_211406_T7</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>337786</th>
      <td>22665778.0</td>
      <td>2114-06-25 17:44:00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Length of Urine Collection</td>
      <td>Urine</td>
      <td>Urine Test</td>
      <td>BATCH_211406_T7</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>926329</th>
      <td>27638257.0</td>
      <td>2189-04-21 16:00:00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Length of Urine Collection</td>
      <td>Urine</td>
      <td>Urine Test</td>
      <td>BATCH_218904_R6</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>926331</th>
      <td>27638257.0</td>
      <td>2189-04-21 16:00:00</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Length of Urine Collection</td>
      <td>Urine</td>
      <td>Urine Test</td>
      <td>BATCH_218904_R6</td>
      <td>OK</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
df = df.drop_duplicates()
```


```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Index: 978501 entries, 0 to 978502
    Data columns (total 14 columns):
     #   Column             Non-Null Count   Dtype  
    ---  ------             --------------   -----  
     0   hadm_id            978501 non-null  float64
     1   charttime          978501 non-null  object 
     2   value              934025 non-null  object 
     3   valuenum           907317 non-null  float64
     4   valueuom           884585 non-null  object 
     5   ref_range_lower    865544 non-null  float64
     6   ref_range_upper    865544 non-null  float64
     7   flag               343687 non-null  object 
     8   label              978501 non-null  object 
     9   fluid              978501 non-null  object 
     10  examination_group  978501 non-null  object 
     11  analysis_batch_id  978501 non-null  object 
     12  qc_flag            978501 non-null  object 
     13  ref_range          146215 non-null  object 
    dtypes: float64(4), object(10)
    memory usage: 112.0+ MB
    


```python
for col in df.columns:
    if col == 'charttime' or col == 'hadm_id' or col == 'subject_id':
        continue
    print(f"{col}: {df[col].value_counts()}")
```

    value: value
    ___      68645
    1         7913
    2.1       7115
    2.0       6928
    1.1       6843
             ...  
    44250        1
    6700         1
    91000        1
    11.04        1
    1382         1
    Name: count, Length: 4284, dtype: int64
    valuenum: valuenum
    1.0       13620
    2.0       11037
    4.0        8480
    14.0       7782
    13.0       7435
              ...  
    3699.0        1
    2871.0        1
    4023.0        1
    2353.0        1
    2373.0        1
    Name: count, Length: 5363, dtype: int64
    valueuom: valueuom
    mg/dL              229227
    mEq/L              202759
    %                  108847
    K/uL                62265
    g/dL                42846
    sec                 42100
    fL                  37094
    m/uL                28489
    pg                  28373
    IU/L                25430
    ng/mL               21768
    mm Hg               14819
    units               11320
    mmol/L               9358
    #/hpf                6590
                         2866
    ug/dL                1700
    pg/mL                1235
    uIU/mL               1117
    Ratio                1070
    #/lpf                 947
    ug/mL                 902
    mOsm/kg               815
    #/uL                  584
    /hpf                  543
    mg/L                  382
    ng/dL                 352
    L/min                 222
    mm/hr                 154
    IU/mL                  92
    U/mL                   68
    mg/mg                  66
    +/-                    23
    mg/24hr                22
    mg/g                   18
    ng/mL FEU              18
    mL                     18
    umol/L                 16
    log10 IU/mL            13
    mIU/mL                 13
    MPL                    12
    GPL                    12
    U                       9
    log10 copies/mL         4
    U/g/Hb                  4
    log10 cop/mL            2
    Pos/Neg                 1
    Name: count, dtype: int64
    ref_range_lower: ref_range_lower
    0.0     56887
    22.0    43066
    3.3     38028
    96.0    37271
    70.0    36959
            ...  
    33.6        1
    60.0        1
    65.0        1
    2.2         1
    4.5         1
    Name: count, Length: 107, dtype: int64
    ref_range_upper: ref_range_upper
    20.0     68665
    32.0     63298
    5.1      37981
    108.0    37271
    145.0    34514
             ...  
    249.0        1
    16.6         1
    158.0        1
    0.9          1
    170.0        1
    Name: count, Length: 149, dtype: int64
    flag: flag
    abnormal    343687
    Name: count, dtype: int64
    label: label
    Glucose                    39744
    Potassium                  37859
    Sodium                     36712
    Chloride                   36612
    Creatinine                 35939
                               ...  
    Urine Fat Bodies               1
    Blue Top Hold Frozen           1
    Phenytoin, Free                1
    Phenytoin, Percent Free        1
    Hematocrit, Ascites            1
    Name: count, Length: 502, dtype: int64
    fluid: fluid
    Blood                  918188
    Urine                   56689
    Pleural                  1881
    Other Body Fluid         1350
    Ascites                   188
    Joint Fluid               141
    Cerebrospinal Fluid        36
    Stool                      15
    Bone Marrow                13
    Name: count, dtype: int64
    examination_group: examination_group
    Complete Blood Count (CBC)    286407
    BMP                           280773
    Renal Function Tests          101250
    Blood Gas                      83046
    Coagulation and Hemostasis     61845
                                   ...  
    LUC                                1
    Homocysteine                       1
    Miscellaneous, Ascites             1
    Myelocytes                         1
    Hematocrit, Ascites                1
    Name: count, Length: 202, dtype: int64
    analysis_batch_id: analysis_batch_id
    BATCH_217602_Z6    39
    BATCH_217602_T1    39
    BATCH_217602_G4    38
    BATCH_217602_S6    37
    BATCH_217602_U9    36
                       ..
    BATCH_212312_Z5     1
    BATCH_212312_M7     1
    BATCH_212312_X6     1
    BATCH_212312_M8     1
    BATCH_212312_T6     1
    Name: count, Length: 227052, dtype: int64
    qc_flag: qc_flag
    OK      880807
    WARN     78124
    FAIL     19570
    Name: count, dtype: int64
    ref_range: ref_range
    Normal range: 10-20     49098
    Normal range: 70-110    48619
    Normal range: 3-5       48498
    Name: count, dtype: int64
    

## Check for wrong NaNs / non typical entries in each column

#### Find wrong NaNs


```python
print("="*80)
print("FIND NON-NUMERICAL ENTRIES IN NUMERICAL COLUMNS")
print("="*80)

# Identify columns that should be numerical
numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()
print(f"\nColumns already numeric: {len(numeric_cols)}")
print(numeric_cols)

# Check object/string columns that might contain numerical data
object_cols = df.select_dtypes(include=['object']).columns.tolist()
print(f"\nObject/String columns to check: {len(object_cols)}")
print(object_cols)

# For each object column, try to find non-numerical entries
print("\n" + "="*80)
print("CHECKING FOR NON-NUMERICAL ENTRIES")
print("="*80)

non_numerical_summary = {}

for col in object_cols:
    non_numerical_entries = []
    
    for idx, value in df[col].items():
        if pd.isna(value):  # Skip NaN/None
            continue
        
        # Try to convert to float
        try:
            float(value)
        except (ValueError, TypeError):
            non_numerical_entries.append({
                'index': idx,
                'value': value,
                'type': type(value).__name__
            })
    
    # Store summary
    if non_numerical_entries:
        non_numerical_summary[col] = non_numerical_entries
        
        print(f"\n{'─'*80}")
        print(f"Column: '{col}' | Non-numerical entries: {len(non_numerical_entries)}")
        print(f"{'─'*80}")
        
        # Get unique non-numerical values
        unique_values = list(set([e['value'] for e in non_numerical_entries]))
        print(f"Unique non-numerical values ({len(unique_values)}):")
        for val in sorted(unique_values)[:20]:  # Show first 20
            count = sum(1 for e in non_numerical_entries if e['value'] == val)
            print(f"  • '{val}' — appears {count} times")
        
        if len(unique_values) > 20:
            print(f"  ... and {len(unique_values) - 20} more")
        
        # Show sample rows
        print(f"\nSample rows with non-numerical entries:")
        for entry in non_numerical_entries[:5]:
            print(f"  Index {entry['index']}: {entry['value']!r} ({entry['type']})")

# Summary
print("\n" + "="*80)
print("SUMMARY")
print("="*80)
print(f"\nColumns with non-numerical entries: {len(non_numerical_summary)}")

for col, entries in non_numerical_summary.items():
    total_rows = len(df)
    non_num_count = len(entries)
    pct = (non_num_count / total_rows) * 100
    unique_count = len(set([e['value'] for e in entries]))
    
    print(f"\n{col}:")
    print(f"  Non-numerical rows: {non_num_count} ({pct:.2f}%)")
    print(f"  Unique non-numerical values: {unique_count}")
    print(f"  Numerical rows: {total_rows - non_num_count}")

# Optional: Create a detailed report
if non_numerical_summary:
    print("\n" + "="*80)
    print("DETAILED REPORT - ALL NON-NUMERICAL ENTRIES")
    print("="*80)
    
    for col in non_numerical_summary:
        print(f"\n{col}:")
        entries_df = pd.DataFrame(non_numerical_summary[col])
        # Count occurrences
        value_counts = entries_df['value'].value_counts()
        print(value_counts)
```

    ================================================================================
    FIND NON-NUMERICAL ENTRIES IN NUMERICAL COLUMNS
    ================================================================================
    
    Columns already numeric: 4
    ['hadm_id', 'valuenum', 'ref_range_lower', 'ref_range_upper']
    
    Object/String columns to check: 10
    ['charttime', 'value', 'valueuom', 'flag', 'label', 'fluid', 'examination_group', 'analysis_batch_id', 'qc_flag', 'ref_range']
    
    ================================================================================
    CHECKING FOR NON-NUMERICAL ENTRIES
    ================================================================================
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'charttime' | Non-numerical entries: 978501
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (66403):
      • '2110-02-01 09:40:00' — appears 24 times
      • '2110-02-01 18:00:00' — appears 5 times
      • '2110-02-02 01:30:00' — appears 4 times
      • '2110-02-02 08:25:00' — appears 21 times
      • '2110-02-02 20:47:00' — appears 4 times
      • '2110-02-03 10:34:00' — appears 4 times
      • '2110-02-16 04:37:00' — appears 9 times
      • '2110-02-16 10:50:00' — appears 26 times
      • '2110-02-17 10:00:00' — appears 20 times
      • '2110-02-18 10:00:00' — appears 20 times
      • '2110-02-19 10:10:00' — appears 20 times
      • '2110-02-25 18:10:00' — appears 3 times
      • '2110-02-26 03:19:00' — appears 13 times
      • '2110-02-26 08:50:00' — appears 22 times
      • '2110-02-27 09:15:00' — appears 20 times
      • '2110-02-27 16:39:00' — appears 33 times
      • '2110-02-27 18:27:00' — appears 1 times
      • '2110-02-27 21:19:00' — appears 5 times
      • '2110-02-28 08:27:00' — appears 25 times
      • '2110-03-01 08:30:00' — appears 23 times
      ... and 66383 more
    
    Sample rows with non-numerical entries:
      Index 0: '2188-01-04 23:43:00' (str)
      Index 1: '2188-01-04 23:43:00' (str)
      Index 2: '2188-01-04 23:43:00' (str)
      Index 3: '2188-01-05 06:56:00' (str)
      Index 4: '2188-01-05 06:56:00' (str)
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'value' | Non-numerical entries: 94777
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (222):
      • '/10.' — appears 6 times
      • '/11.' — appears 3 times
      • '/12.' — appears 17 times
      • '/13.' — appears 6 times
      • '/14.' — appears 14 times
      • '/15.' — appears 9 times
      • '/16.' — appears 30 times
      • '/17.' — appears 13 times
      • '/18.' — appears 29 times
      • '/19.' — appears 7 times
      • '/20.' — appears 23 times
      • '/21.' — appears 10 times
      • '/22.' — appears 13 times
      • '/23.' — appears 6 times
      • '/24.' — appears 21 times
      • '/25.' — appears 18 times
      • '/26.' — appears 6 times
      • '/27.' — appears 8 times
      • '/28.' — appears 5 times
      • '/29.' — appears 1 times
      ... and 202 more
    
    Sample rows with non-numerical entries:
      Index 0: '___' (str)
      Index 2: '___' (str)
      Index 6: '___' (str)
      Index 7: '___' (str)
      Index 16: '___' (str)
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'valueuom' | Non-numerical entries: 884585
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (47):
      • ' ' — appears 2866 times
      • '#/hpf' — appears 6590 times
      • '#/lpf' — appears 947 times
      • '#/uL' — appears 584 times
      • '%' — appears 108847 times
      • '+/-' — appears 23 times
      • '/hpf' — appears 543 times
      • 'GPL' — appears 12 times
      • 'IU/L' — appears 25430 times
      • 'IU/mL' — appears 92 times
      • 'K/uL' — appears 62265 times
      • 'L/min' — appears 222 times
      • 'MPL' — appears 12 times
      • 'Pos/Neg' — appears 1 times
      • 'Ratio' — appears 1070 times
      • 'U' — appears 9 times
      • 'U/g/Hb' — appears 4 times
      • 'U/mL' — appears 68 times
      • 'fL' — appears 37094 times
      • 'g/dL' — appears 42846 times
      ... and 27 more
    
    Sample rows with non-numerical entries:
      Index 0: 'IU/L' (str)
      Index 1: 'ng/mL' (str)
      Index 2: 'ng/mL' (str)
      Index 4: 'sec' (str)
      Index 5: 'sec' (str)
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'flag' | Non-numerical entries: 343687
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (1):
      • 'abnormal' — appears 343687 times
    
    Sample rows with non-numerical entries:
      Index 2: 'abnormal' (str)
      Index 3: 'abnormal' (str)
      Index 4: 'abnormal' (str)
      Index 5: 'abnormal' (str)
      Index 6: 'abnormal' (str)
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'label' | Non-numerical entries: 978501
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (502):
      • '% Hemoglobin A1c' — appears 1080 times
      • '24 hr Calcium' — appears 1 times
      • '24 hr Creatinine' — appears 14 times
      • '24 hr Protein' — appears 7 times
      • '25-OH Vitamin D' — appears 34 times
      • 'ADP' — appears 1 times
      • 'ANCA Titer' — appears 2 times
      • 'ARCH-1' — appears 70 times
      • 'Absolute Basophil Count' — appears 855 times
      • 'Absolute CD3 Count' — appears 11 times
      • 'Absolute CD4 Count' — appears 11 times
      • 'Absolute CD8 Count' — appears 11 times
      • 'Absolute Eosinophil Count' — appears 855 times
      • 'Absolute Lymphocyte Count' — appears 866 times
      • 'Absolute Monocyte Count' — appears 855 times
      • 'Absolute Neutrophil Count' — appears 855 times
      • 'Acanthocytes' — appears 48 times
      • 'Acetaminophen' — appears 62 times
      • 'Acetone' — appears 9 times
      • 'Alanine Aminotransferase (ALT)' — appears 4667 times
      ... and 482 more
    
    Sample rows with non-numerical entries:
      Index 0: 'Creatine Kinase (CK)' (str)
      Index 1: 'Creatine Kinase, MB Isoenzyme' (str)
      Index 2: 'Troponin T' (str)
      Index 3: 'INR(PT)' (str)
      Index 4: 'PT' (str)
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'fluid' | Non-numerical entries: 978501
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (9):
      • 'Ascites' — appears 188 times
      • 'Blood' — appears 918188 times
      • 'Bone Marrow' — appears 13 times
      • 'Cerebrospinal Fluid' — appears 36 times
      • 'Joint Fluid' — appears 141 times
      • 'Other Body Fluid' — appears 1350 times
      • 'Pleural' — appears 1881 times
      • 'Stool' — appears 15 times
      • 'Urine' — appears 56689 times
    
    Sample rows with non-numerical entries:
      Index 0: 'Blood' (str)
      Index 1: 'Blood' (str)
      Index 2: 'Blood' (str)
      Index 3: 'Blood' (str)
      Index 4: 'Blood' (str)
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'examination_group' | Non-numerical entries: 978501
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (202):
      • 'ADP' — appears 1 times
      • 'ANCA Titer' — appears 2 times
      • 'ARCH-1' — appears 70 times
      • 'Absolute CD3 Count' — appears 11 times
      • 'Absolute CD4 Count' — appears 11 times
      • 'Absolute CD8 Count' — appears 11 times
      • 'Acetone' — appears 9 times
      • 'Albumin, Ascites' — appears 14 times
      • 'Albumin, Body Fluid' — appears 58 times
      • 'Albumin, Pleural' — appears 101 times
      • 'Ammonia' — appears 14 times
      • 'Amylase' — appears 410 times
      • 'Amylase, Ascites' — appears 4 times
      • 'Amylase, Body Fluid' — appears 49 times
      • 'Amylase, Pleural' — appears 36 times
      • 'Anat Path Hold' — appears 18 times
      • 'Anticardiolipin Antibody IgG' — appears 12 times
      • 'Anticardiolipin Antibody IgM' — appears 12 times
      • 'Arachadonic Acid' — appears 1 times
      • 'Atypical Lymphocytes' — appears 9 times
      ... and 182 more
    
    Sample rows with non-numerical entries:
      Index 0: 'Cardiac Markers' (str)
      Index 1: 'Cardiac Markers' (str)
      Index 2: 'Cardiac Markers' (str)
      Index 3: 'Coagulation and Hemostasis' (str)
      Index 4: 'Coagulation and Hemostasis' (str)
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'analysis_batch_id' | Non-numerical entries: 978501
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (227052):
      • 'BATCH_211001_D3' — appears 1 times
      • 'BATCH_211001_E4' — appears 1 times
      • 'BATCH_211001_G6' — appears 1 times
      • 'BATCH_211001_J4' — appears 1 times
      • 'BATCH_211001_J9' — appears 1 times
      • 'BATCH_211001_K3' — appears 1 times
      • 'BATCH_211001_K8' — appears 1 times
      • 'BATCH_211001_L6' — appears 1 times
      • 'BATCH_211001_L7' — appears 1 times
      • 'BATCH_211001_M1' — appears 1 times
      • 'BATCH_211001_M2' — appears 1 times
      • 'BATCH_211001_M5' — appears 1 times
      • 'BATCH_211001_M6' — appears 1 times
      • 'BATCH_211001_M8' — appears 1 times
      • 'BATCH_211001_N1' — appears 1 times
      • 'BATCH_211001_N5' — appears 1 times
      • 'BATCH_211001_N9' — appears 1 times
      • 'BATCH_211001_P6' — appears 1 times
      • 'BATCH_211001_P8' — appears 1 times
      • 'BATCH_211001_Q5' — appears 1 times
      ... and 227032 more
    
    Sample rows with non-numerical entries:
      Index 0: 'BATCH_218801_N3' (str)
      Index 1: 'BATCH_218801_C7' (str)
      Index 2: 'BATCH_218801_R4' (str)
      Index 3: 'BATCH_218801_K7' (str)
      Index 4: 'BATCH_218801_B1' (str)
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'qc_flag' | Non-numerical entries: 978501
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (3):
      • 'FAIL' — appears 19570 times
      • 'OK' — appears 880807 times
      • 'WARN' — appears 78124 times
    
    Sample rows with non-numerical entries:
      Index 0: 'OK' (str)
      Index 1: 'OK' (str)
      Index 2: 'OK' (str)
      Index 3: 'OK' (str)
      Index 4: 'WARN' (str)
    
    ────────────────────────────────────────────────────────────────────────────────
    Column: 'ref_range' | Non-numerical entries: 146215
    ────────────────────────────────────────────────────────────────────────────────
    Unique non-numerical values (3):
      • 'Normal range: 10-20' — appears 49098 times
      • 'Normal range: 3-5' — appears 48498 times
      • 'Normal range: 70-110' — appears 48619 times
    
    Sample rows with non-numerical entries:
      Index 6: 'Normal range: 70-110' (str)
      Index 10: 'Normal range: 10-20' (str)
      Index 21: 'Normal range: 3-5' (str)
      Index 29: 'Normal range: 3-5' (str)
      Index 32: 'Normal range: 70-110' (str)
    
    ================================================================================
    SUMMARY
    ================================================================================
    
    Columns with non-numerical entries: 10
    
    charttime:
      Non-numerical rows: 978501 (100.00%)
      Unique non-numerical values: 66403
      Numerical rows: 0
    
    value:
      Non-numerical rows: 94777 (9.69%)
      Unique non-numerical values: 222
      Numerical rows: 883724
    
    valueuom:
      Non-numerical rows: 884585 (90.40%)
      Unique non-numerical values: 47
      Numerical rows: 93916
    
    flag:
      Non-numerical rows: 343687 (35.12%)
      Unique non-numerical values: 1
      Numerical rows: 634814
    
    label:
      Non-numerical rows: 978501 (100.00%)
      Unique non-numerical values: 502
      Numerical rows: 0
    
    fluid:
      Non-numerical rows: 978501 (100.00%)
      Unique non-numerical values: 9
      Numerical rows: 0
    
    examination_group:
      Non-numerical rows: 978501 (100.00%)
      Unique non-numerical values: 202
      Numerical rows: 0
    
    analysis_batch_id:
      Non-numerical rows: 978501 (100.00%)
      Unique non-numerical values: 227052
      Numerical rows: 0
    
    qc_flag:
      Non-numerical rows: 978501 (100.00%)
      Unique non-numerical values: 3
      Numerical rows: 0
    
    ref_range:
      Non-numerical rows: 146215 (14.94%)
      Unique non-numerical values: 3
      Numerical rows: 832286
    
    ================================================================================
    DETAILED REPORT - ALL NON-NUMERICAL ENTRIES
    ================================================================================
    
    charttime:
    value
    2172-04-23 08:45:00    93
    2151-11-26 09:00:00    82
    2176-11-22 09:07:00    81
    2162-03-22 10:00:00    74
    2176-02-03 00:15:00    72
                           ..
    2167-04-27 00:50:00     1
    2167-04-26 17:39:00     1
    2129-08-06 15:03:00     1
    2160-07-12 18:45:00     1
    2124-01-09 03:40:00     1
    Name: count, Length: 66403, dtype: int64
    
    value:
    value
    ___                                                             68645
    ART.                                                             6348
    NEG                                                              4234
    MIX.                                                             2173
    NONE                                                             2070
                                                                    ...  
    26/2.                                                               1
    DUE TO ABNORMAL URINE COLOR, INTERPRET DIPSTICK WITH CAUTION        1
    O                                                                   1
    CLEAN                                                               1
    8/ .                                                                1
    Name: count, Length: 222, dtype: int64
    
    valueuom:
    value
    mg/dL              229227
    mEq/L              202759
    %                  108847
    K/uL                62265
    g/dL                42846
    sec                 42100
    fL                  37094
    m/uL                28489
    pg                  28373
    IU/L                25430
    ng/mL               21768
    mm Hg               14819
    units               11320
    mmol/L               9358
    #/hpf                6590
                         2866
    ug/dL                1700
    pg/mL                1235
    uIU/mL               1117
    Ratio                1070
    #/lpf                 947
    ug/mL                 902
    mOsm/kg               815
    #/uL                  584
    /hpf                  543
    mg/L                  382
    ng/dL                 352
    L/min                 222
    mm/hr                 154
    IU/mL                  92
    U/mL                   68
    mg/mg                  66
    +/-                    23
    mg/24hr                22
    mg/g                   18
    ng/mL FEU              18
    mL                     18
    umol/L                 16
    log10 IU/mL            13
    mIU/mL                 13
    MPL                    12
    GPL                    12
    U                       9
    log10 copies/mL         4
    U/g/Hb                  4
    log10 cop/mL            2
    Pos/Neg                 1
    Name: count, dtype: int64
    
    flag:
    value
    abnormal    343687
    Name: count, dtype: int64
    
    label:
    value
    Glucose                    39744
    Potassium                  37859
    Sodium                     36712
    Chloride                   36612
    Creatinine                 35939
                               ...  
    Urine Fat Bodies               1
    Blue Top Hold Frozen           1
    Phenytoin, Free                1
    Phenytoin, Percent Free        1
    Hematocrit, Ascites            1
    Name: count, Length: 502, dtype: int64
    
    fluid:
    value
    Blood                  918188
    Urine                   56689
    Pleural                  1881
    Other Body Fluid         1350
    Ascites                   188
    Joint Fluid               141
    Cerebrospinal Fluid        36
    Stool                      15
    Bone Marrow                13
    Name: count, dtype: int64
    
    examination_group:
    value
    Complete Blood Count (CBC)    286407
    BMP                           280773
    Renal Function Tests          101250
    Blood Gas                      83046
    Coagulation and Hemostasis     61845
                                   ...  
    LUC                                1
    Homocysteine                       1
    Miscellaneous, Ascites             1
    Myelocytes                         1
    Hematocrit, Ascites                1
    Name: count, Length: 202, dtype: int64
    
    analysis_batch_id:
    value
    BATCH_217602_Z6    39
    BATCH_217602_T1    39
    BATCH_217602_G4    38
    BATCH_217602_S6    37
    BATCH_217602_U9    36
                       ..
    BATCH_212312_Z5     1
    BATCH_212312_M7     1
    BATCH_212312_X6     1
    BATCH_212312_M8     1
    BATCH_212312_T6     1
    Name: count, Length: 227052, dtype: int64
    
    qc_flag:
    value
    OK      880807
    WARN     78124
    FAIL     19570
    Name: count, dtype: int64
    
    ref_range:
    value
    Normal range: 10-20     49098
    Normal range: 70-110    48619
    Normal range: 3-5       48498
    Name: count, dtype: int64
    

- valueuom: has '' , remove; Pos/Neg == +/-; U ??
- value has wrong entries inspect and extrat if possible to valuenum


### Handle Value wrong nans, then extract missing from value into new column valuenum_merged if possible


```python
# # chec k only value column: show all unique non-numerical entries in 'value' column
# non_numerical_values = []
# for idx, value in df['value'].items():
#     if pd.isna(value):  # Skip NaN/None
#         continue
    
#     # Try to convert to float
#     try:
#         float(value)
#     except (ValueError, TypeError):
#         non_numerical_values.append({
#             'index': idx,
#             'value': value,
#             'type': type(value).__name__
#         })
# print(f"\n{'─'*80}")
# print(f"Column: 'value' | Non-numerical entries: {len(non_numerical_values)}")
# print(f"{'─'*80}")
# # Get unique non-numerical values
# unique_values = list(set([e['value'] for e in non_numerical_values]))
# print(f"Unique non-numerical values ({len(unique_values)}):")
# for val in sorted(unique_values):
#     count = sum(1 for e in non_numerical_values if e['value'] == val)
#     print(f"  • '{val}' — appears {count} times")   
    
```

FINDINGS

=> in col value, We want to convert '___' and 'NONE' 'ERROR' to np.nan!

=> then we create a new col value_extracted (float64) out of col value where:
- we can calculate as float complete / like 20/0 but only if there is anumber before and after the /! => complete
- we can take the middle point of complete ranges like '80-160'
- we can calculate a float value of comparisons with < > by sub/add 0.1 to the number, eg. '>1.050' => 1.150 or '<1' => 0.9
- the rest is to nuemic error coerce put to NaN.

=> then, we fill np.nan entries in col valuenum with values from valUe_extracted if they are not nan and tell me the amount of filled rows and show examples beffore and after


```python
#first sanity check if needed
# check are there rows where valuenum has nan but value has a value?a
len(df[(df['valuenum'].isna()) & (df['value'].notna())])
```




    26708




```python
print("="*80)
print("STEP 1: CONVERT PLACEHOLDER STRINGS TO NaN")
print("="*80)

# Define placeholder patterns
placeholders = ['___', 'NONE', 'ERROR']

print(f"\nPlaceholders to convert: {placeholders}")
print(f"Before: {df['value'].isna().sum()} NaN values")

# Convert placeholders to NaN (case-insensitive)
for placeholder in placeholders:
    mask = df['value'].astype(str).str.lower() == placeholder.lower()
    count = mask.sum()
    df.loc[mask, 'value'] = np.nan
    print(f"  Converted '{placeholder}': {count} rows")

print(f"After: {df['value'].isna().sum()} NaN values")
```

    ================================================================================
    STEP 1: CONVERT PLACEHOLDER STRINGS TO NaN
    ================================================================================
    
    Placeholders to convert: ['___', 'NONE', 'ERROR']
    Before: 44476 NaN values
      Converted '___': 68645 rows
      Converted 'NONE': 2070 rows
      Converted 'ERROR': 6 rows
    After: 115197 NaN values
    


```python
print("="*80)
print("STEP 2: EXTRACT NUMERIC VALUES FROM 'value' COLUMN")
print("="*80)

def extract_numeric_from_value(x):
    """
    Extract numeric values from various string formats:
    - Simple numbers: '123' => 123
    - Decimals: '123.45' => 123.45
    - Divisions: '20/10' => 2.0
    - Ranges: '80-160' => 120 (midpoint)
    - Comparisons: '>1.050' => 1.150, '<1' => 0.9
    """
    
    if pd.isna(x):
        return np.nan
    
    x_str = str(x).strip()
    
    # Try direct float conversion
    try:
        return float(x_str)
    except ValueError:
        pass
    
    # Handle divisions (e.g., '20/10')
    if '/' in x_str:
        parts = x_str.split('/')
        try:
            if len(parts) == 2 and parts[0].strip() and parts[1].strip():
                num1 = float(parts[0].strip())
                num2 = float(parts[1].strip())
                if num2 != 0:  # Avoid division by zero
                    return num1 / num2
        except (ValueError, ZeroDivisionError):
            pass
    
    # Handle ranges (e.g., '80-160')
    if '-' in x_str and not x_str.startswith('-'):
        parts = x_str.split('-')
        try:
            if len(parts) == 2 and parts[0].strip() and parts[1].strip():
                num1 = float(parts[0].strip())
                num2 = float(parts[1].strip())
                return (num1 + num2) / 2  # Midpoint
        except ValueError:
            pass
    
    # Handle comparisons (e.g., '>1.050' => 1.150, '<1' => 0.9)
    comparison_match = re.match(r'^([<>]=?)(\d*\.?\d+)$', x_str.strip())
    if comparison_match:
        operator = comparison_match.group(1)
        try:
            num = float(comparison_match.group(2))
            if operator == '>':
                return num + 0.1
            elif operator == '>=':
                return num
            elif operator == '<':
                return num - 0.1
            elif operator == '<=':
                return num
        except ValueError:
            pass
    
    # If nothing worked, return NaN
    return np.nan

# Apply extraction
df['value_extracted'] = df['value'].apply(extract_numeric_from_value)

print(f"\nExtraction complete!")
print(f"Non-null values extracted: {df['value_extracted'].notna().sum():,}")
print(f"Failed extractions (NaN): {df['value_extracted'].isna().sum():,}")
```

    ================================================================================
    STEP 2: EXTRACT NUMERIC VALUES FROM 'value' COLUMN
    ================================================================================
    
    Extraction complete!
    Non-null values extracted: 840,559
    Failed extractions (NaN): 137,942
    


```python
print("="*80)
print("STEP 4: MERGE valuenum + value_extracted")
print("="*80)

# Store counts before merge
valuenum_before = df['valuenum'].notna().sum()
value_extracted_only = (df['valuenum'].isna() & df['value_extracted'].notna()).sum()

print(f"\nBefore merge:")
print(f"  valuenum (non-null):           {valuenum_before:,}")
print(f"  value_extracted (non-null):    {df['value_extracted'].notna().sum():,}")
print(f"  Can be filled from extraction:  {value_extracted_only:,}")

# Merge: prefer valuenum, fallback to value_extracted
df['valuenum_merged'] = df['valuenum'].fillna(df['value_extracted'])

valuenum_after = df['valuenum_merged'].notna().sum()
newly_filled = valuenum_after - valuenum_before

print(f"\nAfter merge:")
print(f"  valuenum_merged (non-null):   {valuenum_after:,}")
print(f"  Newly filled from extraction:   {newly_filled:,} (+{(newly_filled/len(df)*100):.2f}%)")
print(f"  Total improvement:              {valuenum_after - df['valuenum'].isna().sum():,} rows")

print(f"\nData type: {df['valuenum_merged'].dtype}")
print(f"\nStatistics:")
print(df['valuenum_merged'].describe())
```

    ================================================================================
    STEP 4: MERGE valuenum + value_extracted
    ================================================================================
    
    Before merge:
      valuenum (non-null):           907,317
      value_extracted (non-null):    840,559
      Can be filled from extraction:  1,311
    
    After merge:
      valuenum_merged (non-null):   908,628
      Newly filled from extraction:   1,311 (+0.13%)
      Total improvement:              837,444 rows
    
    Data type: float64
    
    Statistics:
    count    908628.000000
    mean         67.258029
    std        2174.021247
    min        -743.000000
    25%           4.300000
    50%          17.000000
    75%          60.000000
    max      886449.000000
    Name: valuenum_merged, dtype: float64
    


```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Index: 978501 entries, 0 to 978502
    Data columns (total 16 columns):
     #   Column             Non-Null Count   Dtype  
    ---  ------             --------------   -----  
     0   hadm_id            978501 non-null  float64
     1   charttime          978501 non-null  object 
     2   value              863304 non-null  object 
     3   valuenum           907317 non-null  float64
     4   valueuom           884585 non-null  object 
     5   ref_range_lower    865544 non-null  float64
     6   ref_range_upper    865544 non-null  float64
     7   flag               343687 non-null  object 
     8   label              978501 non-null  object 
     9   fluid              978501 non-null  object 
     10  examination_group  978501 non-null  object 
     11  analysis_batch_id  978501 non-null  object 
     12  qc_flag            978501 non-null  object 
     13  ref_range          146215 non-null  object 
     14  value_extracted    840559 non-null  float64
     15  valuenum_merged    908628 non-null  float64
    dtypes: float64(6), object(10)
    memory usage: 126.9+ MB
    

 ## Convert datetimes


```python
cols = ['charttime',]  

for col in cols:
    if col in df.columns:
        df[col] = pd.to_datetime(df[col], errors='coerce')
        print(f"{col}: parsed {df[col].notna().sum()} values, {df[col].isna().sum()} NaT")

display(df[[c for c in df.columns if c in cols]])
```

    charttime: parsed 978501 values, 0 NaT
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>charttime</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2188-01-04 23:43:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2188-01-04 23:43:00</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2188-01-04 23:43:00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2188-01-05 06:56:00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2188-01-05 06:56:00</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>978498</th>
      <td>2145-08-02 08:30:00</td>
    </tr>
    <tr>
      <th>978499</th>
      <td>2145-08-02 08:30:00</td>
    </tr>
    <tr>
      <th>978500</th>
      <td>2145-08-02 08:30:00</td>
    </tr>
    <tr>
      <th>978501</th>
      <td>2145-08-02 08:30:00</td>
    </tr>
    <tr>
      <th>978502</th>
      <td>2145-08-02 08:30:00</td>
    </tr>
  </tbody>
</table>
<p>978501 rows × 1 columns</p>
</div>


## inspect qc_flag == FAIL


```python
# check qc_flag == 'FAIL' 
df["qc_flag"].value_counts(), 19570/ len(df), 78124 / len(df)
```




    (qc_flag
     OK      880807
     WARN     78124
     FAIL     19570
     Name: count, dtype: int64,
     0.019999979560572752,
     0.07984049070976933)



2% fail, 8% warn.

IDEA: small percentage => set valuenum_merged to np.nan those rows bc qualtiy control failed


```python
# Handle QC flags
qc_fail_mask = df['qc_flag'] == 'FAIL'
qc_warn_mask = df['qc_flag'] == 'WARN'

# Drop failed measurements from valuenum_merged
before_non_null = df['valuenum_merged'].notna().sum()
df.loc[qc_fail_mask, 'valuenum_merged'] = np.nan
after_non_null = df['valuenum_merged'].notna().sum()

print(f"set {before_non_null - after_non_null:,} FAIL measurements from valuenum_merged to nan.")
print(f"Coverage drop: {(before_non_null - after_non_null) / len(df) * 100:.2f}%")

# Binary QC features for downstream aggregation/clustering
df['is_qc_fail'] = qc_fail_mask.astype(int)
df['is_qc_warn'] = qc_warn_mask.astype(int)
df['is_qc_ok'] = (~qc_fail_mask & ~qc_warn_mask).astype(int)

print(df[['qc_flag', 'is_qc_ok', 'is_qc_warn', 'is_qc_fail']].head())
```

    set 18,185 FAIL measurements from valuenum_merged to nan.
    Coverage drop: 1.86%
      qc_flag  is_qc_ok  is_qc_warn  is_qc_fail
    0      OK         1           0           0
    1      OK         1           0           0
    2      OK         1           0           0
    3      OK         1           0           0
    4    WARN         0           1           0
    

## Little intermed inspection 


```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Index: 978501 entries, 0 to 978502
    Data columns (total 19 columns):
     #   Column             Non-Null Count   Dtype         
    ---  ------             --------------   -----         
     0   hadm_id            978501 non-null  float64       
     1   charttime          978501 non-null  datetime64[ns]
     2   value              863304 non-null  object        
     3   valuenum           907317 non-null  float64       
     4   valueuom           884585 non-null  object        
     5   ref_range_lower    865544 non-null  float64       
     6   ref_range_upper    865544 non-null  float64       
     7   flag               343687 non-null  object        
     8   label              978501 non-null  object        
     9   fluid              978501 non-null  object        
     10  examination_group  978501 non-null  object        
     11  analysis_batch_id  978501 non-null  object        
     12  qc_flag            978501 non-null  object        
     13  ref_range          146215 non-null  object        
     14  value_extracted    840559 non-null  float64       
     15  valuenum_merged    890443 non-null  float64       
     16  is_qc_fail         978501 non-null  int64         
     17  is_qc_warn         978501 non-null  int64         
     18  is_qc_ok           978501 non-null  int64         
    dtypes: datetime64[ns](1), float64(6), int64(3), object(9)
    memory usage: 149.3+ MB
    


```python
df[df.columns].head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hadm_id</th>
      <th>charttime</th>
      <th>value</th>
      <th>valuenum</th>
      <th>valueuom</th>
      <th>ref_range_lower</th>
      <th>ref_range_upper</th>
      <th>flag</th>
      <th>label</th>
      <th>fluid</th>
      <th>examination_group</th>
      <th>analysis_batch_id</th>
      <th>qc_flag</th>
      <th>ref_range</th>
      <th>value_extracted</th>
      <th>valuenum_merged</th>
      <th>is_qc_fail</th>
      <th>is_qc_warn</th>
      <th>is_qc_ok</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>29654838.0</td>
      <td>2188-01-04 23:43:00</td>
      <td>NaN</td>
      <td>198.00</td>
      <td>IU/L</td>
      <td>29.0</td>
      <td>201.00</td>
      <td>NaN</td>
      <td>Creatine Kinase (CK)</td>
      <td>Blood</td>
      <td>Cardiac Markers</td>
      <td>BATCH_218801_N3</td>
      <td>OK</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>198.00</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>29654838.0</td>
      <td>2188-01-04 23:43:00</td>
      <td>5</td>
      <td>5.00</td>
      <td>ng/mL</td>
      <td>0.0</td>
      <td>10.00</td>
      <td>NaN</td>
      <td>Creatine Kinase, MB Isoenzyme</td>
      <td>Blood</td>
      <td>Cardiac Markers</td>
      <td>BATCH_218801_C7</td>
      <td>OK</td>
      <td>NaN</td>
      <td>5.0</td>
      <td>5.00</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>29654838.0</td>
      <td>2188-01-04 23:43:00</td>
      <td>NaN</td>
      <td>0.03</td>
      <td>ng/mL</td>
      <td>0.0</td>
      <td>0.01</td>
      <td>abnormal</td>
      <td>Troponin T</td>
      <td>Blood</td>
      <td>Cardiac Markers</td>
      <td>BATCH_218801_R4</td>
      <td>OK</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.03</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>1.2</td>
      <td>1.20</td>
      <td>NaN</td>
      <td>0.9</td>
      <td>1.10</td>
      <td>abnormal</td>
      <td>INR(PT)</td>
      <td>Blood</td>
      <td>Coagulation and Hemostasis</td>
      <td>BATCH_218801_K7</td>
      <td>OK</td>
      <td>NaN</td>
      <td>1.2</td>
      <td>1.20</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>12.8</td>
      <td>12.80</td>
      <td>sec</td>
      <td>9.4</td>
      <td>12.50</td>
      <td>abnormal</td>
      <td>PT</td>
      <td>Blood</td>
      <td>Coagulation and Hemostasis</td>
      <td>BATCH_218801_B1</td>
      <td>WARN</td>
      <td>NaN</td>
      <td>12.8</td>
      <td>12.80</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>85.8</td>
      <td>85.80</td>
      <td>sec</td>
      <td>25.0</td>
      <td>36.50</td>
      <td>abnormal</td>
      <td>PTT</td>
      <td>Blood</td>
      <td>Coagulation and Hemostasis</td>
      <td>BATCH_218801_R1</td>
      <td>OK</td>
      <td>NaN</td>
      <td>85.8</td>
      <td>85.80</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>NaN</td>
      <td>8.10</td>
      <td>%</td>
      <td>4.8</td>
      <td>5.90</td>
      <td>abnormal</td>
      <td>% Hemoglobin A1c</td>
      <td>Blood</td>
      <td>HbA1c</td>
      <td>BATCH_218801_O1</td>
      <td>OK</td>
      <td>Normal range: 70-110</td>
      <td>NaN</td>
      <td>8.10</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>NaN</td>
      <td>186.00</td>
      <td>mg/dL</td>
      <td>91.0</td>
      <td>123.00</td>
      <td>abnormal</td>
      <td>eAG</td>
      <td>Blood</td>
      <td>HbA1c</td>
      <td>BATCH_218801_P4</td>
      <td>OK</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>186.00</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>19</td>
      <td>19.00</td>
      <td>mEq/L</td>
      <td>8.0</td>
      <td>20.00</td>
      <td>NaN</td>
      <td>Anion Gap</td>
      <td>Blood</td>
      <td>Renal Function Tests</td>
      <td>BATCH_218801_O5</td>
      <td>OK</td>
      <td>NaN</td>
      <td>19.0</td>
      <td>19.00</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>29654838.0</td>
      <td>2188-01-05 06:56:00</td>
      <td>20</td>
      <td>20.00</td>
      <td>mEq/L</td>
      <td>22.0</td>
      <td>32.00</td>
      <td>abnormal</td>
      <td>Bicarbonate</td>
      <td>Blood</td>
      <td>BMP</td>
      <td>BATCH_218801_A1</td>
      <td>OK</td>
      <td>NaN</td>
      <td>20.0</td>
      <td>20.00</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>



## check if flag indidactor (abnormal) is correect (valuenum_merged is within the ranges)


```python
# convert nan / none null vals in flag to 'normal'
df['flag'] = df['flag'].fillna('normal')
```


```python
df["flag"].value_counts()
```




    flag
    normal      634814
    abnormal    343687
    Name: count, dtype: int64




```python
# Check if 'flag' correctly indicates abnormal values based on reference ranges
print("="*80)
print("FLAG CORRECTNESS VALIDATION")
print("="*80)

# Create working columns
df['_val'] = pd.to_numeric(df['valuenum_merged'], errors='coerce')
df['_ref_low'] = pd.to_numeric(df['ref_range_lower'], errors='coerce')
df['_ref_high'] = pd.to_numeric(df['ref_range_upper'], errors='coerce')

# Compute expected flag based on reference ranges
def compute_expected_flag(row):
    val = row['_val']
    low = row['_ref_low']
    high = row['_ref_high']
    
    if pd.isna(val):
        return np.nan  # Can't determine without a value
    if pd.isna(low) and pd.isna(high):
        return np.nan  # No reference range available
    
    # Check if outside bounds
    if pd.notna(low) and pd.notna(high):
        return 'abnormal' if (val < low or val > high) else 'normal'
    elif pd.notna(low):
        return 'abnormal' if val < low else 'normal'
    elif pd.notna(high):
        return 'abnormal' if val > high else 'normal'
    return np.nan

df['_expected_flag'] = df.apply(compute_expected_flag, axis=1)

# Compare with actual flag
checkable = df[df['_expected_flag'].notna()].copy()
checkable['_match'] = checkable['flag'] == checkable['_expected_flag']

# Identify mismatches
mismatches = checkable[~checkable['_match']]

# Summary
print(f"\nTotal rows: {len(df):,}")
print(f"Rows with computable expected flag: {len(checkable):,}")
print(f"Matching flags: {checkable['_match'].sum():,} ({checkable['_match'].mean()*100:.2f}%)")
print(f"Mismatched flags: {len(mismatches):,} ({len(mismatches)/len(checkable)*100:.2f}%)")

# Show mismatch breakdown
if len(mismatches) > 0:
    print("\n" + "-"*80)
    print("MISMATCH BREAKDOWN:")
    print("-"*80)
    mismatch_types = mismatches.groupby(['flag', '_expected_flag']).size().reset_index(name='count')
    print(mismatch_types.to_string(index=False))
    
    # Check how many mismatches have same valuenum as valuenum_merged
    print("\n" + "-"*80)
    print("MISMATCH SOURCE ANALYSIS:")
    print("-"*80)
    mismatches['_same_valuenum'] = mismatches['valuenum'] == mismatches['valuenum_merged']
    same_count = mismatches['_same_valuenum'].sum()
    diff_count = len(mismatches) - same_count
    
    print(f"Mismatches where valuenum == valuenum_merged: {same_count:,} ({same_count/len(mismatches)*100:.2f}%)")
    print(f"Mismatches where valuenum != valuenum_merged: {diff_count:,} ({diff_count/len(mismatches)*100:.2f}%)")
    print(f"  → Original data issue: {same_count/len(mismatches)*100:.1f}%")
    print(f"  → Possibly from value extraction: {diff_count/len(mismatches)*100:.1f}%")
    
    print("\n" + "-"*80)
    print("SAMPLE MISMATCHES (first 20):")
    print("-"*80)
    display(mismatches[['hadm_id', 'label', 'value', 'valuenum', 'valuenum_merged', '_ref_low', '_ref_high', 'ref_range', 'qc_flag',
                        'flag', '_expected_flag', '_same_valuenum']].head(20))

# Cleanup helper columns
df.drop(columns=['_val', '_ref_low', '_ref_high', '_expected_flag'], inplace=True)
```

    ================================================================================
    FLAG CORRECTNESS VALIDATION
    ================================================================================
    
    Total rows: 978,501
    Rows with computable expected flag: 839,483
    Matching flags: 839,181 (99.96%)
    Mismatched flags: 302 (0.04%)
    
    --------------------------------------------------------------------------------
    MISMATCH BREAKDOWN:
    --------------------------------------------------------------------------------
        flag _expected_flag  count
    abnormal         normal      7
      normal       abnormal    295
    
    --------------------------------------------------------------------------------
    MISMATCH SOURCE ANALYSIS:
    --------------------------------------------------------------------------------
    Mismatches where valuenum == valuenum_merged: 141 (46.69%)
    Mismatches where valuenum != valuenum_merged: 161 (53.31%)
      → Original data issue: 46.7%
      → Possibly from value extraction: 53.3%
    
    --------------------------------------------------------------------------------
    SAMPLE MISMATCHES (first 20):
    --------------------------------------------------------------------------------
    

    C:\Users\dgars\AppData\Local\Temp\ipykernel_13756\2940929807.py:58: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame.
    Try using .loc[row_indexer,col_indexer] = value instead
    
    See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
      mismatches['_same_valuenum'] = mismatches['valuenum'] == mismatches['valuenum_merged']
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>hadm_id</th>
      <th>label</th>
      <th>value</th>
      <th>valuenum</th>
      <th>valuenum_merged</th>
      <th>_ref_low</th>
      <th>_ref_high</th>
      <th>ref_range</th>
      <th>qc_flag</th>
      <th>flag</th>
      <th>_expected_flag</th>
      <th>_same_valuenum</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1427</th>
      <td>20668418.0</td>
      <td>Hyaline Casts</td>
      <td>0-2</td>
      <td>NaN</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4410</th>
      <td>29209451.0</td>
      <td>Anion Gap</td>
      <td>22</td>
      <td>22.00</td>
      <td>22.00</td>
      <td>8.00</td>
      <td>20.00</td>
      <td>Normal range: 70-110</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>5392</th>
      <td>22000239.0</td>
      <td>Eosinophils</td>
      <td>0</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>7.00</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>5483</th>
      <td>22000239.0</td>
      <td>Eosinophils</td>
      <td>0</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>7.00</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>5548</th>
      <td>22000239.0</td>
      <td>Eosinophils</td>
      <td>0</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>7.00</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>9158</th>
      <td>21370539.0</td>
      <td>Granular Casts</td>
      <td>0-2</td>
      <td>NaN</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>False</td>
    </tr>
    <tr>
      <th>11886</th>
      <td>23333218.0</td>
      <td>Eosinophils</td>
      <td>0</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>7.00</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>12512</th>
      <td>21396883.0</td>
      <td>Absolute Lymphocyte Count</td>
      <td>6.94</td>
      <td>6.94</td>
      <td>6.94</td>
      <td>1.20</td>
      <td>3.70</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>12517</th>
      <td>21396883.0</td>
      <td>Eosinophils</td>
      <td>0</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>7.00</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>12539</th>
      <td>21396883.0</td>
      <td>Absolute Basophil Count</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.08</td>
      <td>Normal range: 3-5</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>12540</th>
      <td>21396883.0</td>
      <td>Absolute Eosinophil Count</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.04</td>
      <td>0.54</td>
      <td>Normal range: 70-110</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>12541</th>
      <td>21396883.0</td>
      <td>Absolute Monocyte Count</td>
      <td>1.16</td>
      <td>1.16</td>
      <td>1.16</td>
      <td>0.20</td>
      <td>0.80</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>12542</th>
      <td>21396883.0</td>
      <td>Absolute Neutrophil Count</td>
      <td>20.81</td>
      <td>20.81</td>
      <td>20.81</td>
      <td>1.60</td>
      <td>6.10</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>13794</th>
      <td>20688231.0</td>
      <td>Eosinophils</td>
      <td>0</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>1.00</td>
      <td>7.00</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>13805</th>
      <td>20688231.0</td>
      <td>Monocytes</td>
      <td>0</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>5.00</td>
      <td>13.00</td>
      <td>Normal range: 70-110</td>
      <td>WARN</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>13815</th>
      <td>20688231.0</td>
      <td>Absolute Basophil Count</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.01</td>
      <td>0.08</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>13816</th>
      <td>20688231.0</td>
      <td>Absolute Eosinophil Count</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.04</td>
      <td>0.54</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>13817</th>
      <td>20688231.0</td>
      <td>Absolute Monocyte Count</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>0.20</td>
      <td>0.80</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>13818</th>
      <td>20688231.0</td>
      <td>Absolute Neutrophil Count</td>
      <td>10.49</td>
      <td>10.49</td>
      <td>10.49</td>
      <td>1.60</td>
      <td>6.10</td>
      <td>NaN</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>True</td>
    </tr>
    <tr>
      <th>25426</th>
      <td>27440644.0</td>
      <td>Granular Casts</td>
      <td>0-2</td>
      <td>NaN</td>
      <td>1.00</td>
      <td>0.00</td>
      <td>0.00</td>
      <td>Normal range: 70-110</td>
      <td>OK</td>
      <td>normal</td>
      <td>abnormal</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>


fix those where  valuenum == valuenum_merged, put np.nan where !=


```python
# Further fix: For rows with comparison operators (> or <), apply expected flag
# Keep ranges (containing '-') as NaN

# Recompute masks and expected flag
df['_val'] = pd.to_numeric(df['valuenum_merged'], errors='coerce')
df['_ref_low'] = pd.to_numeric(df['ref_range_lower'], errors='coerce')
df['_ref_high'] = pd.to_numeric(df['ref_range_upper'], errors='coerce')

def compute_expected_flag(row):
    val, low, high = row['_val'], row['_ref_low'], row['_ref_high']
    if pd.isna(val) or (pd.isna(low) and pd.isna(high)):
        return np.nan
    if pd.notna(low) and pd.notna(high):
        return 'abnormal' if (val < low or val > high) else 'normal'
    elif pd.notna(low):
        return 'abnormal' if val < low else 'normal'
    elif pd.notna(high):
        return 'abnormal' if val > high else 'normal'
    return np.nan

df['_expected_flag'] = df.apply(compute_expected_flag, axis=1)

# Identify mismatches
mismatch_mask = (df['_expected_flag'].notna()) & (df['flag'] != df['_expected_flag'])

# Check if valuenum == valuenum_merged for mismatches
same_value_mask = df['valuenum'] == df['valuenum_merged']

# Identify comparison values (> or <) vs ranges (-)
has_comparison = df['value'].astype(str).str.contains(r'^[<>]', regex=True, na=False)
has_range = df['value'].astype(str).str.contains(r'^\d+\.?\d*-\d+\.?\d*$', regex=True, na=False)

# Set to NaN where valuenum != valuenum_merged (extraction issue)
nan_mask = mismatch_mask & ~same_value_mask
df.loc[nan_mask, 'flag_corrected'] = np.nan

# Fix comparisons: apply expected flag
comparison_fix_mask = nan_mask & has_comparison
df.loc[comparison_fix_mask, 'flag_corrected'] = df.loc[comparison_fix_mask, '_expected_flag']

print(f"Rows with comparisons (> or <) fixed: {comparison_fix_mask.sum():,}")
print(f"Rows with ranges (-) remaining NaN: {(nan_mask & has_range).sum():,}")

# Cleanup
df.drop(columns=['_val', '_ref_low', '_ref_high', '_expected_flag'], inplace=True)
```

    Rows with comparisons (> or <) fixed: 112
    Rows with ranges (-) remaining NaN: 49
    

    C:\Users\dgars\AppData\Local\Temp\ipykernel_13756\3776882262.py:39: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value '['abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal' 'abnormal'
     'abnormal' 'abnormal' 'abnormal' 'abnormal']' has dtype incompatible with float64, please explicitly cast to a compatible dtype first.
      df.loc[comparison_fix_mask, 'flag_corrected'] = df.loc[comparison_fix_mask, '_expected_flag']
    

## to nan: valueuom: has '' , remove; Pos/Neg == +/-; U ??
keep U


```python
# Handle empty strings and whitespace-only values in valueuom
empty_mask = (df['valueuom'] == '') | (df['valueuom'].astype(str).str.strip() == '')
print(f"  Empty strings '' or whitespace-only: {empty_mask.sum():,} → set to NaN")
df.loc[empty_mask, 'valueuom'] = np.nan
```

      Empty strings '' or whitespace-only: 2,866 → set to NaN
    


```python
df['valueuom'] = df['valueuom'].replace({'Pos/Neg': '+/-'})
```

## Attempt unit normailaztion valueom => valuenum_merged


```python
df["label"].unique()
```




    array(['Creatine Kinase (CK)', 'Creatine Kinase, MB Isoenzyme',
           'Troponin T', 'INR(PT)', 'PT', 'PTT', '% Hemoglobin A1c', 'eAG',
           'Anion Gap', 'Bicarbonate', 'Calcium, Total', 'Chloride',
           'Cholesterol Ratio (Total/HDL)', 'Cholesterol, HDL',
           'Cholesterol, LDL, Calculated', 'Cholesterol, Total', 'Creatinine',
           'Glucose', 'Magnesium', 'Phosphate', 'Potassium', 'Sodium',
           'Triglycerides', 'Urea Nitrogen', 'Hematocrit', 'Hemoglobin',
           'MCH', 'MCHC', 'MCV', 'Platelet Count', 'RDW', 'Red Blood Cells',
           'White Blood Cells', 'Alanine Aminotransferase (ALT)',
           'Asparate Aminotransferase (AST)', 'Albumin',
           'Alkaline Phosphatase', 'Amylase', 'Bilirubin, Direct',
           'Bilirubin, Indirect', 'Bilirubin, Total', 'Vitamin B12',
           'Basophils', 'Eosinophils', 'Lymphocytes', 'Monocytes',
           'Neutrophils', 'EDTA Hold', 'Red Top Hold', 'CK-MB Index',
           'Thyroid Stimulating Hormone', 'Thyroxine (T4), Free',
           'Base Excess', 'Calculated Total CO2', 'Intubated',
           'Oxygen Saturation', 'pCO2', 'pH', 'pO2', 'Specimen Type',
           'Length of Urine Collection', 'Urine tube, held',
           'Estimated GFR (MDRD equation)', 'Osmolality, Measured',
           'Ferritin', 'Folate', 'Iron', 'Iron Binding Capacity, Total',
           'Transferrin', 'Creatinine, Urine', 'Osmolality, Urine',
           'Sodium, Urine', 'Urea Nitrogen, Urine',
           'Amphetamine Screen, Urine', 'Cocaine, Urine', 'Uhold', 'RDW-SD',
           'C-Reactive Protein', 'Cholesterol, LDL, Measured',
           'Sedimentation Rate', 'Green Top Hold (plasma)', 'tacroFK',
           'Bacteria', 'Bilirubin', 'Blood', 'Epithelial Cells',
           'Hyaline Casts', 'Ketone', 'Leukocytes', 'Nitrite', 'Protein',
           'RBC', 'Specific Gravity', 'Transitional Epithelial Cells',
           'Urine Appearance', 'Urine Color', 'Urine Mucous', 'Urobilinogen',
           'WBC', 'Yeast', 'H', 'I', 'L', 'Anti-Nuclear Antibody',
           'Protein Electrophoresis', 'Protein, Total', 'Free Kappa',
           'Free Kappa/Free Lambda Ratio', 'Free Lambda',
           'Immunofixation, Urine', 'Prot. Electrophoresis, Urine',
           'Protein/Creatinine Ratio', 'Total Protein, Urine',
           'Granular Casts', 'Chloride, Whole Blood', 'Free Calcium',
           'Hematocrit, Calculated', 'Lactate', 'Potassium, Whole Blood',
           'Sodium, Whole Blood', 'Ventilator', 'Fibrinogen, Functional',
           'Temperature', 'PEEP', 'Ventilation Rate', 'NTproBNP',
           'Absolute Lymphocyte Count', 'Absolute Basophil Count',
           'Absolute Eosinophil Count', 'Absolute Monocyte Count',
           'Absolute Neutrophil Count', 'Immature Granulocytes',
           'Blue Top Hold', 'D-Dimer', 'Light Green Top Hold',
           'Lactate Dehydrogenase (LD)', 'Assist/Control', 'Chloride, Urine',
           'Potassium, Urine', 'Platelet Smear', 'Lipase',
           'Amorphous Crystals', 'Digoxin', 'Vancomycin', 'Granulocyte Count',
           'Anisocytosis', 'Atypical Lymphocytes', 'Bands', 'Hypochromia',
           'Macrocytes', 'Metamyelocytes', 'Microcytes', 'Myelocytes',
           'Poikilocytosis', 'Polychromasia', 'Ovalocytes',
           'Barbiturate Screen, Urine', 'Benzodiazepine Screen, Urine',
           'Methadone, Urine', 'Opiate Screen, Urine', 'Voided Specimen',
           'Carboxyhemoglobin', 'Methemoglobin',
           'Hepatitis B Surface Antibody', 'Hepatitis B Surface Antigen',
           'Hepatitis B Virus Core Antibody', 'Hepatitis C Virus Antibody',
           'Cyclosporin', 'Oxygen', 'Uric Acid', 'Hematocrit, Other Fluid',
           'Monos', 'Polys', 'Total Nucleated Cells, Other',
           'Albumin, Body Fluid', 'Amylase, Body Fluid',
           'Glucose, Body Fluid', 'LD, Body Fluid',
           'Total Protein, Body Fluid', 'Nucleated Red Cells', 'Schistocytes',
           'Teardrop Cells', 'Echinocytes', 'Thyroxine (T4)',
           'Uric Acid, Urine', 'Haptoglobin', 'Reticulocyte Count, Automated',
           'Tidal Volume', 'Acanthocytes', 'Basophilic Stippling',
           'Target Cells', '24 hr Creatinine', '24 hr Protein',
           'Urine Volume', 'Bite Cells', 'Alveolar-arterial Gradient',
           'Required O2', 'Triiodothyronine (T3)', 'ARCH-1', 'HIV Screen',
           'Large Platelets', 'Fibrin Degradation Products', 'Globulin',
           'Macrophages', 'Mesothelial Cells', 'RBC, Pleural',
           'Total Nucleated Cells, Pleural', 'Albumin, Pleural',
           'Lactate Dehydrogenase, Pleural', 'Total Protein, Pleural',
           'Acetaminophen', 'Barbiturate Screen', 'Benzodiazepine Screen',
           'Salicylate', 'Tricyclic Antidepressant Screen',
           'Problem Specimen', 'O2 Flow', 'H/O Smear', 'Influenza A by PCR',
           'Influenza B by PCR', 'Albumin, Urine',
           'Albumin/Creatinine, Urine', 'Reticulocyte Count, Absolute',
           'Immunofixation', 'Immunoglobulin A', 'Immunoglobulin G',
           'Immunoglobulin M', 'WBC Clumps', 'Ammonia',
           'Beta-2 Microglobulin', 'C3', 'C4', 'Cortisol',
           'Gamma Glutamyltransferase', 'Cholesterol, Pleural',
           'Glucose, Pleural', 'Miscellaneous, Pleural', 'Albumin, Ascites',
           'Macrophage', 'Mesothelial Cell', 'RBC, Ascites',
           'Total Nucleated Cells, Ascites', 'Amylase, Pleural',
           'Hematocrit, Pleural', 'Phosphate, Urine', 'Alpha-Fetoprotein',
           'Human Chorionic Gonadotropin', 'CD10', 'CD19', 'CD20', 'CD45',
           'CD5', 'Immunophenotyping', 'Kappa', 'Lambda', 'Anat Path Hold',
           'Fragmented Cells', 'Triglycerides, Pleural', 'Rheumatoid Factor',
           'Reticulocyte Count, Manual', 'Anti-Mitochondrial Antibody',
           'Anti-Smooth Muscle Antibody', 'Urine Casts, Other',
           'Bicarbonate, Urine', 'Valproic Acid', 'Creatinine, Pleural',
           'Other', 'Anti-Neutrophil Cytoplasmic Antibody',
           'Anti-Nuclear Antibody, Titer', 'ANCA Titer', 'Uric Acid Crystals',
           'Calculated Bicarbonate, Whole Blood',
           'Hepatitis B Core Antibody, IgM', 'Prostate Specific Antigen',
           'Ethanol', 'Hepatitis C Viral Load', 'HPE7', 'HPE8', 'STX1',
           'STX2', 'STX3', 'STX4', 'STX5', 'STX6', 'Oxycodone', 'UTX1',
           'UTX2', 'UTX3', 'UTX4', 'UTX5', 'UTX6', 'UTX7',
           'Hepatitis A Virus Antibody', 'Hepatitis A Virus IgM Antibody',
           'DHEA-Sulfate', 'CA-125', 'Carcinoembyronic Antigen (CEA)',
           'Inpatient Hematology/Oncology Smear', 'HPE1',
           'Miscellaneous, Body Fluid', 'Lupus Anticoagulant',
           '25-OH Vitamin D', 'Parathyroid Hormone', 'Double Stranded DNA',
           'Cryoglobulin', 'Anticardiolipin Antibody IgG',
           'Anticardiolipin Antibody IgM', 'RBC, Other Fluid', 'Glucose, CSF',
           'Total Protein, CSF', 'Lymphs', 'RBC, CSF',
           'Total Nucleated Cells, CSF', 'Renal Epithelial Cells',
           'Phenytoin', 'Tissue Transglutaminase Ab, IgA', 'Heparin, LMW',
           'Spherocytes', 'Blood, Occult', 'Other Cell', 'HPE2', 'HPE3',
           'Thyroid Peroxidase Antibodies', 'Calculated TBG',
           'Calculated Thyroxine (T4) Index', 'Uptake Ratio',
           'Urine Specimen Type', 'HPE4', 'Cytomegalovirus Viral Load',
           'Joint Crystals, Birefringence', 'Joint Crystals, Comment',
           'Joint Crystals, Location', 'Joint Crystals, Number',
           'Joint Crystals, Shape', 'RBC, Joint Fluid',
           'Total Nucleated Cells, Joint', 'HIV 1 Viral Load',
           'Promyelocytes', 'Elliptocytes', 'Pencil Cells', 'Sickle Cells',
           'CD16/56', 'CD2', 'CD23', 'CD3', 'CD4', 'CD7', 'CD8', 'FMC-7',
           'HLA-DR', 'RBC Casts', 'Blood Parasite Smear', 'Hemoglobin A2',
           'Hemoglobin C', 'Hemogloblin A', 'Hemogloblin S',
           'HCG, Urine, Qualitative', 'EE1', 'EE2', 'EE6', '24 hr Calcium',
           'Calcium, Urine', 'Acetone', 'Gentamicin', 'Absolute CD3 Count',
           'Absolute CD4 Count', 'Absolute CD8 Count', 'CD3 Cells, Percent',
           'CD4 Cells, Percent', 'CD4/CD8 Ratio', 'CD8 Cells, Percent',
           'Lymphocytes, Percent', 'WBC Count',
           'Anti-Thyroglobulin Antibodies', 'Thyroglobulin',
           'Protein C, Functional', 'Protein S, Functional', 'Urine Comments',
           'Quantitative G6PD', 'Thrombin', 'Heparin', 'Blasts',
           'Howell-Jolly Bodies', 'Other Cells', 'Mesothelial cells',
           'Lithium', 'Plasma Cells', 'Calcium Oxalate Crystals',
           'proBNP, Pleural', 'Hematocrit, Joint Fluid', 'Serum Viscosity',
           'Myoglobin, Urine', 'Ammonium Biurate', 'Magnesium, Urine',
           'Urine Crystals, Other', 'Centromere', 'Hemoglobin F',
           'Antithrombin', 'Protein C, Antigen', 'Protein S, Antigen',
           'Factor VIII', 'Von Willebrand Factor Activity',
           'Von Willebrand Factor Antigen', 'Eosinophil Count',
           'Gray Top Hold (plasma)', 'Pappenheimer Bodies', 'Tobramycin',
           'Creatinine, Whole Blood', 'RBC Morphology', 'Rapamycin',
           'Hemosiderin', 'CD13', 'CD34', 'Factor V', 'Glucose, Ascites',
           'Lactate Dehydrogenase, Ascites', 'Total Protein, Ascites',
           'Plasma', 'NRBC', 'WBC Casts', 'Chlamydia trachomatis',
           'Neisseria gonorrhoeae', 'PAN1', 'Trichomonas vaginalis', 'PAN2',
           'Amylase, Ascites', 'CD3 %', 'CD3 Absolute Count', 'CD5 %',
           'CD5 Absolute Count', 'Inhibitor Screen', 'HPE6',
           'Norovirus Genogroup I', 'Norovirus Genogroup II', 'RFXLDLM',
           'CD16/56 Absolute Count', 'CD16/56%', 'CD19 %',
           'CD19 Absolute Count', 'CD20 %', 'CD20 Absolute Count',
           'Platelet Clumps', 'Bilirubin, Total, Ascites',
           'Bilirubin, Total, Pleural', 'Cellular Cast',
           'HIV 1 Ab Confirmation', 'HIV 2 Ab Confirmation',
           'Creatinine, Ascites', 'Reducing Substances, Urine',
           'MacroOvalocytes', 'Factor II', 'Factor VII', 'Factor X',
           'Hepatitis B Viral Load', 'Ethanol, Urine', 'Envelope Cells',
           'HIT-Ab Interpreted Result', 'HIT-Ab Numerical Result',
           'G6PD, Qualitative', 'EE7', 'Broad Casts',
           'Triglycerides, Ascites', 'EE3', 'EE5', 'HPE5', 'Urine Fat Bodies',
           'Blue Top Hold Frozen', 'Phenytoin, Free',
           'Phenytoin, Percent Free', 'ADP', 'Arachadonic Acid', 'Collagen',
           'Epinepherine', 'Phenobarbital', 'Cancer Antigen 27.29',
           'Triple Phosphate Crystals', 'Bicarbonate, Other Fluid',
           'Calcium, Body Fluid', 'Chloride, Body Fluid',
           'Creatinine, Body Fluid', 'Phosphate, Body Fluid',
           'Potassium, Body Fluid', 'Sodium, Body Fluid',
           'Urea Nitrogen, Body Fluid', 'Methotrexate', 'Waxy Casts',
           'NonSquamous Epithelial Cell', 'CD117', 'CD14', 'CD15', 'CD33',
           'CD56', 'CD64', 'LUC', 'Non-squamous Epithelial Cells', 'Sperm',
           'Glucose, Urine', 'Triglycer', 'Homocysteine', 'Young Cells',
           'Miscellaneous, Ascites', 'Hematocrit, Ascites'], dtype=object)




```python
# Format: (label_lowercase, from_unit) : (factor, to_unit)
conversion_map = {
    # Basic Metabolic Panel
    ('glucose', 'mg/dL'): (0.0555, 'mmol/L'),
    ('creatinine', 'mg/dL'): (88.4, 'µmol/L'),
    ('urea nitrogen', 'mg/dL'): (0.357, 'mmol/L'),
    ('bicarbonate', 'mEq/L'): (1.0, 'mmol/L'),
    ('anion gap', 'mEq/L'): (1.0, 'mmol/L'),
    ('calcium, total', 'mg/dL'): (0.25, 'mmol/L'),
    ('magnesium', 'mg/dL'): (0.411, 'mmol/L'),
    ('phosphate', 'mg/dL'): (0.323, 'mmol/L'),
    ('potassium', 'mEq/L'): (1.0, 'mmol/L'),
    ('sodium', 'mEq/L'): (1.0, 'mmol/L'),
    ('triglycerides', 'mg/dL'): (0.0113, 'mmol/L'),
    ('cholesterol, total', 'mg/dL'): (0.0259, 'mmol/L'),
    ('cholesterol, ldl, calculated', 'mg/dL'): (0.0259, 'mmol/L'),
    ('cholesterol, hdl', 'mg/dL'): (0.0259, 'mmol/L'),

    # Hematology
    ('hemoglobin', 'g/dL'): (10.0, 'g/L'),
    ('hematocrit', '%'): (1.0, '%'),
    ('red blood cells', 'M/uL'): (1e6, '/uL'),
    ('white blood cells', 'K/uL'): (1000, '/uL'),
    ('platelet count', 'K/uL'): (1000, '/uL'),
    ('mch', 'pg'): (1.0, 'pg'),
    ('mchc', 'g/dL'): (10.0, 'g/L'),
    ('mcv', 'fL'): (1.0, 'fL'),
    ('rdw', '%'): (1.0, '%'),

    # Coagulation / Blood Gas
    ('ptt', 'sec'): (1.0, 'sec'),
    ('pt', 'sec'): (1.0, 'sec'),
    ('inr(pt)', 'ratio'): (1.0, 'ratio'),
    ('ph', ''): (1.0, ''),
    ('pco2', 'mm Hg'): (0.133, 'kPa'),
    ('po2', 'mm Hg'): (0.133, 'kPa'),
    ('base excess', 'mmol/L'): (1.0, 'mmol/L'),
    ('calculated total co2', 'mmol/L'): (1.0, 'mmol/L'),

    # Enzymes
    ('alanine aminotransferase (alt)', 'U/L'): (1.0, 'U/L'),
    ('asparate aminotransferase (ast)', 'U/L'): (1.0, 'U/L'),
    ('alkaline phosphatase', 'U/L'): (1.0, 'U/L'),
    ('creatine kinase (ck)', 'U/L'): (1.0, 'U/L'),
    ('creatine kinase, mb isoenzyme', 'U/L'): (1.0, 'U/L'),

    # Bilirubin
    ('bilirubin, total', 'mg/dL'): (17.1, 'µmol/L'),
    ('bilirubin', 'mg/dL'): (17.1, 'µmol/L'),

    # Protein / Albumin
    ('albumin', 'g/dL'): (10.0, 'g/L'),
    ('protein, total', 'g/dL'): (10.0, 'g/L'),

    # Lactate / Calcium
    ('lactate', 'mmol/L'): (1.0, 'mmol/L'),
    ('free calcium', 'mg/dL'): (0.25, 'mmol/L'),

    # Blood gases
    ('oxygen saturation', '%'): (1.0, '%'),
}
```

These include qualitative tests, ratios, percentages, indices, specimen types, or already standardized units:


```python
non_convertible_labels = [
    'Creatine Kinase (CK)', 'Creatine Kinase, MB Isoenzyme', 'Troponin T', 'INR(PT)',
    'PT', 'PTT', '% Hemoglobin A1c', 'eAG', 'Anion Gap', 'Cholesterol Ratio (Total/HDL)',
    'Specimen Type', 'EDTA Hold', 'Red Top Hold', 'Intubated', 'Ventilator', 'PEEP',
    'Ventilation Rate', 'Required O2', 'H', 'L', 'I', 'Uhold', 'Other', 'Problem Specimen',
    'Voided Specimen', 'Urine Specimen Type', 'Blue Top Hold', 'Green Top Hold (plasma)',
    'Gray Top Hold (plasma)', 'Light Green Top Hold', 'Red Top Hold', 'Plasma', 'NRBC',
    'WBC Clumps', 'Other Cells', 'Other Cell', 'NonSquamous Epithelial Cell',
    'Non-squamous Epithelial Cells', 'Urobilinogen', 'Urine Appearance', 'Urine Color',
    'Urine Mucous', 'Bacteria', 'Blood', 'Epithelial Cells', 'Hyaline Casts', 'Ketone',
    'Leukocytes', 'Nitrite', 'Yeast', 'Amorphous Crystals', 'Voided Specimen',
    'Macrocytes', 'Microcytes', 'Schistocytes', 'Teardrop Cells', 'Echinocytes',
    'Spherocytes', 'Ovalocytes', 'Bite Cells', 'Target Cells', 'Elliptocytes', 'Pencil Cells',
    'Sickle Cells', 'Triple Phosphate Crystals', 'Waxy Casts', 'Granular Casts',
    'Cellular Cast', 'RBC Casts', 'Protein Electrophoresis', 'Immunofixation', 'CK-MB Index',
    'Free Kappa', 'Free Lambda', 'Free Kappa/Free Lambda Ratio', 'Immature Granulocytes',
    'CD markers', 'Anti-Nuclear Antibody', 'Hepatitis B Surface Antibody', 'Hepatitis C Virus Antibody',
    'HIV Screen', 'Influenza A by PCR', 'Influenza B by PCR', 'G6PD, Qualitative',
    'Calculated Thyroxine (T4) Index', 'Uptake Ratio', 'Calculated TBG', 'EtOH',
    'Specimen-related holds', 'Ventilation/oxygen settings'
]

```


```python
# Add tracking before conversion
summary_rows = []

for (analyte, from_unit), (factor, to_unit) in conversion_map.items():
    mask = (df['label'].str.lower() == analyte) & (df['valueuom'] == from_unit)
    n_matched = mask.sum()
    
    if n_matched == 0:
        summary_rows.append({
            'analyte': analyte,
            'from_unit': from_unit,
            'to_unit': to_unit,
            'rows_matched': 0,
            'rows_converted': 0,
            'rows_failed': 0,
            'status': 'NO MATCH'
        })
        continue
    
    # Attempt conversion with tracking
    before = pd.to_numeric(df.loc[mask, 'valuenum_merged'], errors='coerce')
    n_non_null_before = before.notna().sum()
    
    # Apply conversion
    after = before * factor
    n_non_null_after = after.notna().sum()
    
    # Identify failed conversions
    n_failed = n_non_null_before - n_non_null_after  # Should be 0 if multiplication works
    
    # Update dataframe
    df.loc[mask, 'valuenum_merged'] = after
    df.loc[mask, 'valueuom'] = to_unit
    
    summary_rows.append({
        'analyte': analyte,
        'from_unit': from_unit,
        'to_unit': to_unit,
        'rows_matched': n_matched,
        'rows_converted': n_non_null_after,
        'rows_failed': n_failed,
        'status': 'OK' if n_failed == 0 else 'PARTIAL'
    })

summary_df = pd.DataFrame(summary_rows)
print(summary_df[summary_df['status'] == 'PARTIAL'])  # ← Show problem conversions
print(f"\nTotal rows matched: {summary_df['rows_matched'].sum()}")
print(f"Total rows converted: {summary_df['rows_converted'].sum()}")
```

    Empty DataFrame
    Columns: [analyte, from_unit, to_unit, rows_matched, rows_converted, rows_failed, status]
    Index: []
    
    Total rows matched: 642381
    Total rows converted: 623605
    

## Handle missing values


```python
# print sum of all missing values per column
for col in df.columns:
    missing_count = df[col].isna().sum()
    if missing_count > 0:
        print(f"Column '{col}': {missing_count} missing values")
```

    Column 'value': 115197 missing values
    Column 'valuenum': 71184 missing values
    Column 'valueuom': 96782 missing values
    Column 'ref_range_lower': 112957 missing values
    Column 'ref_range_upper': 112957 missing values
    Column 'ref_range': 832286 missing values
    Column 'value_extracted': 137942 missing values
    Column 'valuenum_merged': 88058 missing values
    Column 'flag_corrected': 978389 missing values
    

## Do scatterpltos / distr / etc to check for dataqualtiy and remove physcically impossible values


```python
df.columns
```




    Index(['hadm_id', 'charttime', 'value', 'valuenum', 'valueuom',
           'ref_range_lower', 'ref_range_upper', 'flag', 'label', 'fluid',
           'examination_group', 'analysis_batch_id', 'qc_flag', 'ref_range',
           'value_extracted', 'valuenum_merged', 'is_qc_fail', 'is_qc_warn',
           'is_qc_ok', 'flag_corrected'],
          dtype='object')




```python
df["flag"].value_counts(dropna=False), 343687/(343687+634814)
```




    (flag
     normal      634814
     abnormal    343687
     Name: count, dtype: int64,
     0.3512382716011532)




```python
df["label"].unique()
```




    array(['Creatine Kinase (CK)', 'Creatine Kinase, MB Isoenzyme',
           'Troponin T', 'INR(PT)', 'PT', 'PTT', '% Hemoglobin A1c', 'eAG',
           'Anion Gap', 'Bicarbonate', 'Calcium, Total', 'Chloride',
           'Cholesterol Ratio (Total/HDL)', 'Cholesterol, HDL',
           'Cholesterol, LDL, Calculated', 'Cholesterol, Total', 'Creatinine',
           'Glucose', 'Magnesium', 'Phosphate', 'Potassium', 'Sodium',
           'Triglycerides', 'Urea Nitrogen', 'Hematocrit', 'Hemoglobin',
           'MCH', 'MCHC', 'MCV', 'Platelet Count', 'RDW', 'Red Blood Cells',
           'White Blood Cells', 'Alanine Aminotransferase (ALT)',
           'Asparate Aminotransferase (AST)', 'Albumin',
           'Alkaline Phosphatase', 'Amylase', 'Bilirubin, Direct',
           'Bilirubin, Indirect', 'Bilirubin, Total', 'Vitamin B12',
           'Basophils', 'Eosinophils', 'Lymphocytes', 'Monocytes',
           'Neutrophils', 'EDTA Hold', 'Red Top Hold', 'CK-MB Index',
           'Thyroid Stimulating Hormone', 'Thyroxine (T4), Free',
           'Base Excess', 'Calculated Total CO2', 'Intubated',
           'Oxygen Saturation', 'pCO2', 'pH', 'pO2', 'Specimen Type',
           'Length of Urine Collection', 'Urine tube, held',
           'Estimated GFR (MDRD equation)', 'Osmolality, Measured',
           'Ferritin', 'Folate', 'Iron', 'Iron Binding Capacity, Total',
           'Transferrin', 'Creatinine, Urine', 'Osmolality, Urine',
           'Sodium, Urine', 'Urea Nitrogen, Urine',
           'Amphetamine Screen, Urine', 'Cocaine, Urine', 'Uhold', 'RDW-SD',
           'C-Reactive Protein', 'Cholesterol, LDL, Measured',
           'Sedimentation Rate', 'Green Top Hold (plasma)', 'tacroFK',
           'Bacteria', 'Bilirubin', 'Blood', 'Epithelial Cells',
           'Hyaline Casts', 'Ketone', 'Leukocytes', 'Nitrite', 'Protein',
           'RBC', 'Specific Gravity', 'Transitional Epithelial Cells',
           'Urine Appearance', 'Urine Color', 'Urine Mucous', 'Urobilinogen',
           'WBC', 'Yeast', 'H', 'I', 'L', 'Anti-Nuclear Antibody',
           'Protein Electrophoresis', 'Protein, Total', 'Free Kappa',
           'Free Kappa/Free Lambda Ratio', 'Free Lambda',
           'Immunofixation, Urine', 'Prot. Electrophoresis, Urine',
           'Protein/Creatinine Ratio', 'Total Protein, Urine',
           'Granular Casts', 'Chloride, Whole Blood', 'Free Calcium',
           'Hematocrit, Calculated', 'Lactate', 'Potassium, Whole Blood',
           'Sodium, Whole Blood', 'Ventilator', 'Fibrinogen, Functional',
           'Temperature', 'PEEP', 'Ventilation Rate', 'NTproBNP',
           'Absolute Lymphocyte Count', 'Absolute Basophil Count',
           'Absolute Eosinophil Count', 'Absolute Monocyte Count',
           'Absolute Neutrophil Count', 'Immature Granulocytes',
           'Blue Top Hold', 'D-Dimer', 'Light Green Top Hold',
           'Lactate Dehydrogenase (LD)', 'Assist/Control', 'Chloride, Urine',
           'Potassium, Urine', 'Platelet Smear', 'Lipase',
           'Amorphous Crystals', 'Digoxin', 'Vancomycin', 'Granulocyte Count',
           'Anisocytosis', 'Atypical Lymphocytes', 'Bands', 'Hypochromia',
           'Macrocytes', 'Metamyelocytes', 'Microcytes', 'Myelocytes',
           'Poikilocytosis', 'Polychromasia', 'Ovalocytes',
           'Barbiturate Screen, Urine', 'Benzodiazepine Screen, Urine',
           'Methadone, Urine', 'Opiate Screen, Urine', 'Voided Specimen',
           'Carboxyhemoglobin', 'Methemoglobin',
           'Hepatitis B Surface Antibody', 'Hepatitis B Surface Antigen',
           'Hepatitis B Virus Core Antibody', 'Hepatitis C Virus Antibody',
           'Cyclosporin', 'Oxygen', 'Uric Acid', 'Hematocrit, Other Fluid',
           'Monos', 'Polys', 'Total Nucleated Cells, Other',
           'Albumin, Body Fluid', 'Amylase, Body Fluid',
           'Glucose, Body Fluid', 'LD, Body Fluid',
           'Total Protein, Body Fluid', 'Nucleated Red Cells', 'Schistocytes',
           'Teardrop Cells', 'Echinocytes', 'Thyroxine (T4)',
           'Uric Acid, Urine', 'Haptoglobin', 'Reticulocyte Count, Automated',
           'Tidal Volume', 'Acanthocytes', 'Basophilic Stippling',
           'Target Cells', '24 hr Creatinine', '24 hr Protein',
           'Urine Volume', 'Bite Cells', 'Alveolar-arterial Gradient',
           'Required O2', 'Triiodothyronine (T3)', 'ARCH-1', 'HIV Screen',
           'Large Platelets', 'Fibrin Degradation Products', 'Globulin',
           'Macrophages', 'Mesothelial Cells', 'RBC, Pleural',
           'Total Nucleated Cells, Pleural', 'Albumin, Pleural',
           'Lactate Dehydrogenase, Pleural', 'Total Protein, Pleural',
           'Acetaminophen', 'Barbiturate Screen', 'Benzodiazepine Screen',
           'Salicylate', 'Tricyclic Antidepressant Screen',
           'Problem Specimen', 'O2 Flow', 'H/O Smear', 'Influenza A by PCR',
           'Influenza B by PCR', 'Albumin, Urine',
           'Albumin/Creatinine, Urine', 'Reticulocyte Count, Absolute',
           'Immunofixation', 'Immunoglobulin A', 'Immunoglobulin G',
           'Immunoglobulin M', 'WBC Clumps', 'Ammonia',
           'Beta-2 Microglobulin', 'C3', 'C4', 'Cortisol',
           'Gamma Glutamyltransferase', 'Cholesterol, Pleural',
           'Glucose, Pleural', 'Miscellaneous, Pleural', 'Albumin, Ascites',
           'Macrophage', 'Mesothelial Cell', 'RBC, Ascites',
           'Total Nucleated Cells, Ascites', 'Amylase, Pleural',
           'Hematocrit, Pleural', 'Phosphate, Urine', 'Alpha-Fetoprotein',
           'Human Chorionic Gonadotropin', 'CD10', 'CD19', 'CD20', 'CD45',
           'CD5', 'Immunophenotyping', 'Kappa', 'Lambda', 'Anat Path Hold',
           'Fragmented Cells', 'Triglycerides, Pleural', 'Rheumatoid Factor',
           'Reticulocyte Count, Manual', 'Anti-Mitochondrial Antibody',
           'Anti-Smooth Muscle Antibody', 'Urine Casts, Other',
           'Bicarbonate, Urine', 'Valproic Acid', 'Creatinine, Pleural',
           'Other', 'Anti-Neutrophil Cytoplasmic Antibody',
           'Anti-Nuclear Antibody, Titer', 'ANCA Titer', 'Uric Acid Crystals',
           'Calculated Bicarbonate, Whole Blood',
           'Hepatitis B Core Antibody, IgM', 'Prostate Specific Antigen',
           'Ethanol', 'Hepatitis C Viral Load', 'HPE7', 'HPE8', 'STX1',
           'STX2', 'STX3', 'STX4', 'STX5', 'STX6', 'Oxycodone', 'UTX1',
           'UTX2', 'UTX3', 'UTX4', 'UTX5', 'UTX6', 'UTX7',
           'Hepatitis A Virus Antibody', 'Hepatitis A Virus IgM Antibody',
           'DHEA-Sulfate', 'CA-125', 'Carcinoembyronic Antigen (CEA)',
           'Inpatient Hematology/Oncology Smear', 'HPE1',
           'Miscellaneous, Body Fluid', 'Lupus Anticoagulant',
           '25-OH Vitamin D', 'Parathyroid Hormone', 'Double Stranded DNA',
           'Cryoglobulin', 'Anticardiolipin Antibody IgG',
           'Anticardiolipin Antibody IgM', 'RBC, Other Fluid', 'Glucose, CSF',
           'Total Protein, CSF', 'Lymphs', 'RBC, CSF',
           'Total Nucleated Cells, CSF', 'Renal Epithelial Cells',
           'Phenytoin', 'Tissue Transglutaminase Ab, IgA', 'Heparin, LMW',
           'Spherocytes', 'Blood, Occult', 'Other Cell', 'HPE2', 'HPE3',
           'Thyroid Peroxidase Antibodies', 'Calculated TBG',
           'Calculated Thyroxine (T4) Index', 'Uptake Ratio',
           'Urine Specimen Type', 'HPE4', 'Cytomegalovirus Viral Load',
           'Joint Crystals, Birefringence', 'Joint Crystals, Comment',
           'Joint Crystals, Location', 'Joint Crystals, Number',
           'Joint Crystals, Shape', 'RBC, Joint Fluid',
           'Total Nucleated Cells, Joint', 'HIV 1 Viral Load',
           'Promyelocytes', 'Elliptocytes', 'Pencil Cells', 'Sickle Cells',
           'CD16/56', 'CD2', 'CD23', 'CD3', 'CD4', 'CD7', 'CD8', 'FMC-7',
           'HLA-DR', 'RBC Casts', 'Blood Parasite Smear', 'Hemoglobin A2',
           'Hemoglobin C', 'Hemogloblin A', 'Hemogloblin S',
           'HCG, Urine, Qualitative', 'EE1', 'EE2', 'EE6', '24 hr Calcium',
           'Calcium, Urine', 'Acetone', 'Gentamicin', 'Absolute CD3 Count',
           'Absolute CD4 Count', 'Absolute CD8 Count', 'CD3 Cells, Percent',
           'CD4 Cells, Percent', 'CD4/CD8 Ratio', 'CD8 Cells, Percent',
           'Lymphocytes, Percent', 'WBC Count',
           'Anti-Thyroglobulin Antibodies', 'Thyroglobulin',
           'Protein C, Functional', 'Protein S, Functional', 'Urine Comments',
           'Quantitative G6PD', 'Thrombin', 'Heparin', 'Blasts',
           'Howell-Jolly Bodies', 'Other Cells', 'Mesothelial cells',
           'Lithium', 'Plasma Cells', 'Calcium Oxalate Crystals',
           'proBNP, Pleural', 'Hematocrit, Joint Fluid', 'Serum Viscosity',
           'Myoglobin, Urine', 'Ammonium Biurate', 'Magnesium, Urine',
           'Urine Crystals, Other', 'Centromere', 'Hemoglobin F',
           'Antithrombin', 'Protein C, Antigen', 'Protein S, Antigen',
           'Factor VIII', 'Von Willebrand Factor Activity',
           'Von Willebrand Factor Antigen', 'Eosinophil Count',
           'Gray Top Hold (plasma)', 'Pappenheimer Bodies', 'Tobramycin',
           'Creatinine, Whole Blood', 'RBC Morphology', 'Rapamycin',
           'Hemosiderin', 'CD13', 'CD34', 'Factor V', 'Glucose, Ascites',
           'Lactate Dehydrogenase, Ascites', 'Total Protein, Ascites',
           'Plasma', 'NRBC', 'WBC Casts', 'Chlamydia trachomatis',
           'Neisseria gonorrhoeae', 'PAN1', 'Trichomonas vaginalis', 'PAN2',
           'Amylase, Ascites', 'CD3 %', 'CD3 Absolute Count', 'CD5 %',
           'CD5 Absolute Count', 'Inhibitor Screen', 'HPE6',
           'Norovirus Genogroup I', 'Norovirus Genogroup II', 'RFXLDLM',
           'CD16/56 Absolute Count', 'CD16/56%', 'CD19 %',
           'CD19 Absolute Count', 'CD20 %', 'CD20 Absolute Count',
           'Platelet Clumps', 'Bilirubin, Total, Ascites',
           'Bilirubin, Total, Pleural', 'Cellular Cast',
           'HIV 1 Ab Confirmation', 'HIV 2 Ab Confirmation',
           'Creatinine, Ascites', 'Reducing Substances, Urine',
           'MacroOvalocytes', 'Factor II', 'Factor VII', 'Factor X',
           'Hepatitis B Viral Load', 'Ethanol, Urine', 'Envelope Cells',
           'HIT-Ab Interpreted Result', 'HIT-Ab Numerical Result',
           'G6PD, Qualitative', 'EE7', 'Broad Casts',
           'Triglycerides, Ascites', 'EE3', 'EE5', 'HPE5', 'Urine Fat Bodies',
           'Blue Top Hold Frozen', 'Phenytoin, Free',
           'Phenytoin, Percent Free', 'ADP', 'Arachadonic Acid', 'Collagen',
           'Epinepherine', 'Phenobarbital', 'Cancer Antigen 27.29',
           'Triple Phosphate Crystals', 'Bicarbonate, Other Fluid',
           'Calcium, Body Fluid', 'Chloride, Body Fluid',
           'Creatinine, Body Fluid', 'Phosphate, Body Fluid',
           'Potassium, Body Fluid', 'Sodium, Body Fluid',
           'Urea Nitrogen, Body Fluid', 'Methotrexate', 'Waxy Casts',
           'NonSquamous Epithelial Cell', 'CD117', 'CD14', 'CD15', 'CD33',
           'CD56', 'CD64', 'LUC', 'Non-squamous Epithelial Cells', 'Sperm',
           'Glucose, Urine', 'Triglycer', 'Homocysteine', 'Young Cells',
           'Miscellaneous, Ascites', 'Hematocrit, Ascites'], dtype=object)




```python
# PHYSIO_LIMITS = {
#     "glucose": (0.5, 60),
#     "creatinine": (10, 1500),
#     "urea nitrogen": (0.5, 80),
#     "sodium": (110, 170),
#     "potassium": (1.5, 8.5),
#     "chloride": (70, 130),
#     "bicarbonate": (5, 45),
#     "anion gap": (1, 40),
#     "magnesium": (0.2, 3.0),
#     "phosphate": (0.2, 2.5),

#     "pH": (6.8, 7.8),
#     "pCO2": (10, 120),
#     "pO2": (20, 500),
#     "base excess": (-30, 25),
#     "oxygen_saturation": (0, 100),

#     "hemoglobin": (30, 230),
#     "hematocrit": (5, 70),
#     "rbc": (1, 8),
#     "wbc": (0.1, 80),
#     "platelets": (10, 1500),
#     "rdw": (5, 30),

#     "C-Reactive Protein": (0, 500),
#     "ast": (0, 5000),
#     "alt": (0, 5000),
#     "bilirubin_total": (0, 1000),
#     "albumin": (10, 60),
#     "lactate": (0.1, 20),
#     "ld": (50, 5000)
# }
```


```python
# TODO maybe remove phyiscal limits?
```


```python
# # Clean numeric lab values using PHYSIO_LIMITS: set valuenum_merged (and value where applicable) to NaN
# df['label_norm'] = df['label'].astype(str).str.lower().str.strip()
# physio_lower = {k.lower(): v for k, v in PHYSIO_LIMITS.items()}

# # find which physio vars are present
# vars_present = [v for v in physio_lower.keys() if v in df['label_norm'].unique()]
# if not vars_present:
#     print("No PHYSIO_LIMITS variables found in df['label'].")
# else:
#     print(f"Vars to check ({len(vars_present)}): {vars_present}")

#     # helper to collect arrays for boxplot
#     def arrays_for_vars(df_src, vars_list):
#         arrs = []
#         counts = []
#         for v in vars_list:
#             s = pd.to_numeric(df_src.loc[df_src['label_norm'] == v, 'valuenum_merged'], errors='coerce').dropna()
#             arrs.append(s.values)
#             counts.append(len(s))
#         return arrs, counts

#     # BEFORE
#     arrs_before, counts_before = arrays_for_vars(df, vars_present)
#     plt.figure(figsize=(max(6, len(vars_present)*1.2), 6))
#     plt.boxplot([a if len(a)>0 else [np.nan] for a in arrs_before], labels=vars_present, showfliers=False)
#     plt.xticks(rotation=45, ha='right')
#     plt.title("Before cleaning: valuenum_merged (per analyte)")
#     plt.tight_layout()
#     plt.show()

#     # Apply physio limits -> set out-of-range to NaN
#     removed_summary = []
#     for v in vars_present:
#         low, high = physio_lower[v]
#         mask = df['label_norm'] == v
#         vals = pd.to_numeric(df.loc[mask, 'valuenum_merged'], errors='coerce')
#         out_of_range = mask & vals.notna() & ((vals < low) | (vals > high))
#         n_out = int(out_of_range.sum())
#         removed_summary.append((v, low, high, n_out))
#         # set numeric column to NaN where out of range
#         df.loc[out_of_range, 'valuenum_merged'] = np.nan
#         # also clear original textual 'value' for those rows to reflect cleaning
#         df.loc[out_of_range, 'value'] = np.nan

#     # report removals
#     print("\nRemoved / set to NaN (per analyte):")
#     for v, low, high, n in removed_summary:
#         print(f"  {v}: {n} rows outside [{low}, {high}]")

#     # AFTER
#     arrs_after, counts_after = arrays_for_vars(df, vars_present)
#     plt.figure(figsize=(max(6, len(vars_present)*1.2), 6))
#     plt.boxplot([a if len(a)>0 else [np.nan] for a in arrs_after], labels=vars_present, showfliers=False)
#     plt.xticks(rotation=45, ha='right')
#     plt.title("After cleaning: valuenum_merged (per analyte)")
#     plt.tight_layout()
#     plt.show()

#     # concise before/after counts
#     print("\nCounts before -> after (non-null valuenum_merged):")
#     for v, before_cnt, after_cnt in zip(vars_present, counts_before, counts_after):
#         print(f"  {v}: {before_cnt} -> {after_cnt} (removed {before_cnt - after_cnt})")
```

## Save


```python
df.to_csv(f"{DATA_DIR}/{DATASETS[name].replace('.csv', '_cleaned.csv')}", index=False)
```


```python
# load already cleaned to skip first steps
#df = pd.read_csv(f"{DATA_DIR}/{DATASETS[name].replace('.csv', '_cleaned.csv')}")
```


```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Index: 978501 entries, 0 to 978502
    Data columns (total 20 columns):
     #   Column             Non-Null Count   Dtype         
    ---  ------             --------------   -----         
     0   hadm_id            978501 non-null  float64       
     1   charttime          978501 non-null  datetime64[ns]
     2   value              863304 non-null  object        
     3   valuenum           907317 non-null  float64       
     4   valueuom           881719 non-null  object        
     5   ref_range_lower    865544 non-null  float64       
     6   ref_range_upper    865544 non-null  float64       
     7   flag               978501 non-null  object        
     8   label              978501 non-null  object        
     9   fluid              978501 non-null  object        
     10  examination_group  978501 non-null  object        
     11  analysis_batch_id  978501 non-null  object        
     12  qc_flag            978501 non-null  object        
     13  ref_range          146215 non-null  object        
     14  value_extracted    840559 non-null  float64       
     15  valuenum_merged    890443 non-null  float64       
     16  is_qc_fail         978501 non-null  int64         
     17  is_qc_warn         978501 non-null  int64         
     18  is_qc_ok           978501 non-null  int64         
     19  flag_corrected     112 non-null     object        
    dtypes: datetime64[ns](1), float64(6), int64(3), object(10)
    memory usage: 156.8+ MB
    

## Add subject id from df1, df3, and df4


```python
# Load other _cleaned dataframes to get subject_id  
df1 = pd.read_csv(f"{DATA_DIR}/heart_diagnoses_1_cleaned.csv")
df3 = pd.read_csv(f"{DATA_DIR}/microbiology_events_codes_3_cleaned.csv")
df4 = pd.read_csv(f"{DATA_DIR}/procedure_code_4_cleaned.csv")

# Merge with Heart Diagnoses to get subject_id
df = df.merge(
    df1[['hadm_id', 'subject_id']].drop_duplicates(),
    on='hadm_id', how='left'
)
print(f"subject_id filled: {df['subject_id'].notna().sum():,} / {len(df):,}")
print(f"subject_id missing: {df['subject_id'].isna().sum():,}")

# Fill gaps from microbiology
df = df.merge(
    df3[['hadm_id', 'subject_id']].drop_duplicates(),
    on='hadm_id', how='left', suffixes=('', '_micro')
)
df['subject_id'] = df['subject_id'].fillna(df['subject_id_micro'])
df = df.drop(columns=['subject_id_micro'])

print(f"subject_id filled: {df['subject_id'].notna().sum():,} / {len(df):,}")
print(f"subject_id missing: {df['subject_id'].isna().sum():,}")

# Fill from procedures as last source
df = df.merge(
    df4[['hadm_id', 'subject_id']].drop_duplicates(),
    on='hadm_id', how='left', suffixes=('', '_proc')
)
df['subject_id'] = df['subject_id'].fillna(df['subject_id_proc'])
df = df.drop(columns=['subject_id_proc'])

# Summary
print(f"subject_id filled: {df['subject_id'].notna().sum():,} / {len(df):,}")
print(f"subject_id missing: {df['subject_id'].isna().sum():,}")
```

    subject_id filled: 1,000,809 / 1,000,809
    subject_id missing: 0
    subject_id filled: 1,167,595 / 1,167,595
    subject_id missing: 0
    subject_id filled: 1,167,595 / 1,167,595
    subject_id missing: 0
    


```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 1167595 entries, 0 to 1167594
    Data columns (total 21 columns):
     #   Column             Non-Null Count    Dtype         
    ---  ------             --------------    -----         
     0   hadm_id            1167595 non-null  float64       
     1   charttime          1167595 non-null  datetime64[ns]
     2   value              1029619 non-null  object        
     3   valuenum           1079027 non-null  float64       
     4   valueuom           1047395 non-null  object        
     5   ref_range_lower    1024390 non-null  float64       
     6   ref_range_upper    1024390 non-null  float64       
     7   flag               1167595 non-null  object        
     8   label              1167595 non-null  object        
     9   fluid              1167595 non-null  object        
     10  examination_group  1167595 non-null  object        
     11  analysis_batch_id  1167595 non-null  object        
     12  qc_flag            1167595 non-null  object        
     13  ref_range          174401 non-null   object        
     14  value_extracted    999529 non-null   float64       
     15  valuenum_merged    1059157 non-null  float64       
     16  is_qc_fail         1167595 non-null  int64         
     17  is_qc_warn         1167595 non-null  int64         
     18  is_qc_ok           1167595 non-null  int64         
     19  flag_corrected     147 non-null      object        
     20  subject_id         1167595 non-null  int64         
    dtypes: datetime64[ns](1), float64(6), int64(4), object(10)
    memory usage: 187.1+ MB
    


```python
df.to_csv(f"{DATA_DIR}/{DATASETS[name].replace('.csv', '_cleaned.csv')}", index=False)
```

## Create features and slim version


```python
df_slim = df.copy()
```


```python
df_slim.columns
```




    Index(['hadm_id', 'charttime', 'value', 'valuenum', 'valueuom',
           'ref_range_lower', 'ref_range_upper', 'flag', 'label', 'fluid',
           'examination_group', 'analysis_batch_id', 'qc_flag', 'ref_range',
           'value_extracted', 'valuenum_merged', 'is_qc_fail', 'is_qc_warn',
           'is_qc_ok', 'flag_corrected', 'subject_id'],
          dtype='object')



# Task 1.2 Create features
- var for exams
- var for charttime?
- var for dod (is_dead?), anchor_year?


```python
df_slim = df_slim.sort_values(['subject_id', 'hadm_id', 'charttime'])
gb = df_slim.groupby(['subject_id', 'hadm_id'])
```


```python
def first_non_null(series):
    """Get first non-null value, or None if all null"""
    non_null = series.dropna()
    return non_null.iloc[0] if len(non_null) > 0 else None
```

## Features:


```python
# True if any unique examination_group equals 'microbiology' (case-insensitive)
is_microbiology_present = any(str(i).lower() == 'microbiology' for i in df_slim['examination_group'].unique())
is_microbiology_present
```




    False




```python
feat_count = gb.size().rename('num_labs')
```


```python
feat_abnormal = gb['flag_corrected'].apply(
    lambda x: (x == 'abnormal').mean()
).rename('abnormal_ratio')
```


```python
feat_qc_fail_rate = gb['is_qc_fail'].mean().rename('qc_fail_ratio')
```


```python
# List of core labels we want to track by fluid
blood_labels = [
    "glucose", "lactate", "anion gap", "bicarbonate", "creatinine", 
    "urea nitrogen", "phosphate", "potassium", "sodium",
    "c-reactive protein", "ast", "alt", "ld", # Added Liver/Inflammation
    "hemoglobin", "hematocrit", "rbc", "rdw"  # Added Hematology
]
urine_labels = ["glucose", "creatinine", "urea nitrogen", "sodium", "protein"]
gas_labels   = ["pO2", "pCO2", "pH", "base excess"]

def extract_refined_features(group):
    feature_dict = {}
    
    # 1. Helper for specific Fluid + Label matching
    def get_stat(label, fluid, stat='max'):
        mask = (group['label'].str.contains(label, case=False, na=False)) & \
               (group['fluid'].str.contains(fluid, case=False, na=False))
        vals = group.loc[mask, 'valuenum_merged']
        if len(vals) == 0: return np.nan
        return vals.max() if stat == 'max' else vals.min()

    # 2. Extract Blood Features
    for var in blood_labels:
        # Most blood markers use MAX for stress, but Hemoglobin/Hematocrit use MIN for anemia
        s = 'min' if var in ['hemoglobin', 'hematocrit'] else 'max'
        feature_dict[f"{s}_blood_{var}"] = get_stat(var, 'Blood', s)

    # 3. Extract Urine Features (Focus on renal/metabolic output)
    for var in urine_labels:
        feature_dict[f"max_urine_{var}"] = get_stat(var, 'Urine', 'max')

    # 4. Extract Blood Gas Features (Critical Respiratory)
    for var in gas_labels:
        feature_dict[f"max_gas_{var}"] = get_stat(var, 'Blood', 'max')

    # 5. Leverage Examination Groups for "System Intensity"
    # Count how many times a system was checked
    sys_counts = group['examination_group'].value_counts()
    feature_dict['count_cbc'] = sys_counts.get('Complete Blood Count (CBC)', 0)
    feature_dict['count_blood_gas'] = sys_counts.get('Blood Gas', 0)
    feature_dict['count_liver'] = sys_counts.get('Liver Function Tests', 0)
    feature_dict['count_cardiac'] = sys_counts.get('Cardiac Markers', 0)

    return pd.Series(feature_dict)

# Apply to your long-form data
df_refined_labs = gb.apply(extract_refined_features).reset_index()
```

    C:\Users\dgars\AppData\Local\Temp\ipykernel_13756\97441195.py:47: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
      df_refined_labs = gb.apply(extract_refined_features).reset_index()
    


```python
df_refined_labs.columns
```




    Index(['subject_id', 'hadm_id', 'max_blood_glucose', 'max_blood_lactate',
           'max_blood_anion gap', 'max_blood_bicarbonate', 'max_blood_creatinine',
           'max_blood_urea nitrogen', 'max_blood_phosphate', 'max_blood_potassium',
           'max_blood_sodium', 'max_blood_c-reactive protein', 'max_blood_ast',
           'max_blood_alt', 'max_blood_ld', 'min_blood_hemoglobin',
           'min_blood_hematocrit', 'max_blood_rbc', 'max_blood_rdw',
           'max_urine_glucose', 'max_urine_creatinine', 'max_urine_urea nitrogen',
           'max_urine_sodium', 'max_urine_protein', 'max_gas_pO2', 'max_gas_pCO2',
           'max_gas_pH', 'max_gas_base excess', 'count_cbc', 'count_blood_gas',
           'count_liver', 'count_cardiac'],
          dtype='object')




```python
feat_qc_fail_rate.head(2)
```




    subject_id  hadm_id   
    10000980    26913865.0    0.024096
                29654838.0    0.000000
    Name: qc_fail_ratio, dtype: float64




```python
feat_time_span = (
    (gb['charttime'].max() - gb['charttime'].min())
    .dt.total_seconds() / 3600
).rename('lab_time_span_hours')

```


```python
feat_unique_tests = gb['label'].nunique().rename('unique_lab_tests')
feat_unique_groups = gb['examination_group'].nunique().rename('unique_examination_groups')
feat_unique_fluids = gb['fluid'].nunique().rename('fluid_diversity')
feat_unique_batches = gb['analysis_batch_id'].nunique().rename('unique_analysis_batches')
```


```python
parts = [
    feat_count.reset_index(),         # was a Series with MultiIndex
    feat_abnormal.reset_index(),
    feat_qc_fail_rate.reset_index(),
    feat_time_span.reset_index(),
    feat_unique_tests.reset_index(),
    feat_unique_groups.reset_index(),
    feat_unique_fluids.reset_index(),
    feat_unique_batches.reset_index(),
    df_refined_labs
]

from functools import reduce
feat = reduce(lambda L, R: pd.merge(L, R, on=['subject_id','hadm_id'], how='outer'), parts)
feat['has_labs'] = 1
feat.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>subject_id</th>
      <th>hadm_id</th>
      <th>num_labs</th>
      <th>abnormal_ratio</th>
      <th>qc_fail_ratio</th>
      <th>lab_time_span_hours</th>
      <th>unique_lab_tests</th>
      <th>unique_examination_groups</th>
      <th>fluid_diversity</th>
      <th>unique_analysis_batches</th>
      <th>...</th>
      <th>max_urine_protein</th>
      <th>max_gas_pO2</th>
      <th>max_gas_pCO2</th>
      <th>max_gas_pH</th>
      <th>max_gas_base excess</th>
      <th>count_cbc</th>
      <th>count_blood_gas</th>
      <th>count_liver</th>
      <th>count_cardiac</th>
      <th>has_labs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10000980</td>
      <td>26913865.0</td>
      <td>166</td>
      <td>0.0</td>
      <td>0.024096</td>
      <td>140.466667</td>
      <td>45</td>
      <td>12</td>
      <td>1</td>
      <td>136</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>73.2000</td>
      <td>NaN</td>
      <td>59.0</td>
      <td>0.0</td>
      <td>7.0</td>
      <td>10.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10000980</td>
      <td>29654838.0</td>
      <td>59</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>33.433333</td>
      <td>35</td>
      <td>8</td>
      <td>1</td>
      <td>53</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.7119</td>
      <td>NaN</td>
      <td>18.0</td>
      <td>0.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10002013</td>
      <td>24760295.0</td>
      <td>50</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>31.183333</td>
      <td>26</td>
      <td>5</td>
      <td>1</td>
      <td>43</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.1305</td>
      <td>NaN</td>
      <td>18.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10002155</td>
      <td>23822395.0</td>
      <td>397</td>
      <td>0.0</td>
      <td>0.030227</td>
      <td>325.400000</td>
      <td>56</td>
      <td>9</td>
      <td>2</td>
      <td>191</td>
      <td>...</td>
      <td>NaN</td>
      <td>10.108</td>
      <td>6.384</td>
      <td>82.4000</td>
      <td>3.0</td>
      <td>132.0</td>
      <td>15.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10004457</td>
      <td>28723315.0</td>
      <td>25</td>
      <td>0.0</td>
      <td>0.040000</td>
      <td>0.000000</td>
      <td>25</td>
      <td>4</td>
      <td>1</td>
      <td>22</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0013</td>
      <td>NaN</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 34 columns</p>
</div>




```python
feat.isna().sum()
```




    subject_id                         0
    hadm_id                            0
    num_labs                           0
    abnormal_ratio                     0
    qc_fail_ratio                      0
    lab_time_span_hours                0
    unique_lab_tests                   0
    unique_examination_groups          0
    fluid_diversity                    0
    unique_analysis_batches            0
    max_blood_glucose                 33
    max_blood_lactate               2844
    max_blood_anion gap               31
    max_blood_creatinine              20
    max_blood_urea nitrogen           20
    max_blood_potassium               17
    max_blood_sodium                  28
    min_blood_hemoglobin              48
    min_blood_hematocrit              30
    max_blood_c-reactive protein    4622
    max_urine_glucose               4647
    max_urine_creatinine            4050
    max_urine_urea nitrogen         4226
    max_urine_sodium                4179
    max_urine_protein               3952
    max_gas_pO2                     3653
    max_gas_pCO2                    3658
    max_gas_pH                       142
    max_gas_base excess             3652
    count_cbc                          0
    count_blood_gas                    0
    count_liver                        0
    count_cardiac                      0
    has_labs                           0
    dtype: int64




```python
feat.columns
```




    Index(['subject_id', 'hadm_id', 'num_labs', 'abnormal_ratio', 'qc_fail_ratio',
           'lab_time_span_hours', 'unique_lab_tests', 'unique_examination_groups',
           'fluid_diversity', 'unique_analysis_batches', 'max_blood_glucose',
           'max_blood_lactate', 'max_blood_anion gap', 'max_blood_creatinine',
           'max_blood_urea nitrogen', 'max_blood_potassium', 'max_blood_sodium',
           'min_blood_hemoglobin', 'min_blood_hematocrit',
           'max_blood_c-reactive protein', 'max_urine_glucose',
           'max_urine_creatinine', 'max_urine_urea nitrogen', 'max_urine_sodium',
           'max_urine_protein', 'max_gas_pO2', 'max_gas_pCO2', 'max_gas_pH',
           'max_gas_base excess', 'count_cbc', 'count_blood_gas', 'count_liver',
           'count_cardiac', 'has_labs'],
          dtype='object')



### Corr


```python
numeric_cols = feat.select_dtypes(include='number').columns

#numeric_cols = [c for c in numeric_cols if c != 'num_labs' or c != 'unique_lab_tests']

corr = feat[numeric_cols].corr()

# Create figure with two views
fig, axes = plt.subplots(1, 2, figsize=(20, 16))

# Plot 1: Full heatmap with annotations
ax1 = axes[0]
sns.heatmap(corr, 
            annot=True, 
            fmt='.2f', 
            cmap='coolwarm', 
            center=0,
            square=True,
            linewidths=0.5,
            annot_kws={'size': 6},
            cbar_kws={'label': 'Correlation', 'shrink': 0.8},
            ax=ax1)
ax1.set_title('Full Correlation Matrix', fontsize=14, fontweight='bold')
plt.setp(ax1.get_xticklabels(), rotation=45, ha='right', fontsize=8)
plt.setp(ax1.get_yticklabels(), rotation=0, fontsize=8)

print("="*80)
print("STRONG CORRELATIONS (|r| > 0.7, excluding self-correlations)")
print("="*80)

strong_corr = []
for i in range(len(corr.columns)):
    for j in range(i+1, len(corr.columns)):
        r = corr.iloc[i, j]
        if abs(r) > 0.7:
            strong_corr.append({
                'Variable 1': corr.columns[i],
                'Variable 2': corr.columns[j],
                'Correlation': round(r, 3),
                'Strength': 'Very Strong' if abs(r) > 0.9 else 'Strong'
            })

if strong_corr:
    strong_df = pd.DataFrame(strong_corr).sort_values('Correlation', key=abs, ascending=False)
    print(f"\nFound {len(strong_corr)} highly correlated pairs:\n")
    display(strong_df)
    print("\n💡 Consider removing one variable from each pair to reduce multicollinearity")
else:
    print("\nNo correlations with |r| > 0.7 found")

# Moderate correlations
print("\n" + "="*80)
print("MODERATE CORRELATIONS (0.5 < |r| ≤ 0.7)")
print("="*80)

moderate_corr = []
for i in range(len(corr.columns)):
    for j in range(i+1, len(corr.columns)):
        r = corr.iloc[i, j]
        if 0.5 < abs(r) <= 0.7:
            moderate_corr.append({
                'Variable 1': corr.columns[i],
                'Variable 2': corr.columns[j],
                'Correlation': round(r, 3)
            })

if moderate_corr:
    moderate_df = pd.DataFrame(moderate_corr).sort_values('Correlation', key=abs, ascending=False)
    print(f"\nFound {len(moderate_corr)} moderately correlated pairs:\n")
    display(moderate_df)
else:
    print("\nNo moderate correlations found")
```

    ================================================================================
    STRONG CORRELATIONS (|r| > 0.7, excluding self-correlations)
    ================================================================================
    
    Found 10 highly correlated pairs:
    
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable 1</th>
      <th>Variable 2</th>
      <th>Correlation</th>
      <th>Strength</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>num_labs</td>
      <td>count_cbc</td>
      <td>0.973</td>
      <td>Very Strong</td>
    </tr>
    <tr>
      <th>2</th>
      <td>num_labs</td>
      <td>count_liver</td>
      <td>0.887</td>
      <td>Strong</td>
    </tr>
    <tr>
      <th>1</th>
      <td>num_labs</td>
      <td>count_blood_gas</td>
      <td>0.886</td>
      <td>Strong</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lab_time_span_hours</td>
      <td>unique_analysis_batches</td>
      <td>0.886</td>
      <td>Strong</td>
    </tr>
    <tr>
      <th>8</th>
      <td>count_cbc</td>
      <td>count_liver</td>
      <td>0.846</td>
      <td>Strong</td>
    </tr>
    <tr>
      <th>9</th>
      <td>count_blood_gas</td>
      <td>count_liver</td>
      <td>0.816</td>
      <td>Strong</td>
    </tr>
    <tr>
      <th>7</th>
      <td>count_cbc</td>
      <td>count_blood_gas</td>
      <td>0.787</td>
      <td>Strong</td>
    </tr>
    <tr>
      <th>6</th>
      <td>unique_lab_tests</td>
      <td>unique_analysis_batches</td>
      <td>0.775</td>
      <td>Strong</td>
    </tr>
    <tr>
      <th>4</th>
      <td>unique_lab_tests</td>
      <td>unique_examination_groups</td>
      <td>0.770</td>
      <td>Strong</td>
    </tr>
    <tr>
      <th>5</th>
      <td>unique_lab_tests</td>
      <td>fluid_diversity</td>
      <td>0.723</td>
      <td>Strong</td>
    </tr>
  </tbody>
</table>
</div>


    
    💡 Consider removing one variable from each pair to reduce multicollinearity
    
    ================================================================================
    MODERATE CORRELATIONS (0.5 < |r| ≤ 0.7)
    ================================================================================
    
    Found 19 moderately correlated pairs:
    
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Variable 1</th>
      <th>Variable 2</th>
      <th>Correlation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8</th>
      <td>unique_examination_groups</td>
      <td>fluid_diversity</td>
      <td>0.683</td>
    </tr>
    <tr>
      <th>6</th>
      <td>lab_time_span_hours</td>
      <td>count_cbc</td>
      <td>0.672</td>
    </tr>
    <tr>
      <th>3</th>
      <td>num_labs</td>
      <td>count_cardiac</td>
      <td>0.652</td>
    </tr>
    <tr>
      <th>14</th>
      <td>max_blood_creatinine</td>
      <td>max_blood_urea nitrogen</td>
      <td>0.644</td>
    </tr>
    <tr>
      <th>4</th>
      <td>lab_time_span_hours</td>
      <td>unique_lab_tests</td>
      <td>0.641</td>
    </tr>
    <tr>
      <th>16</th>
      <td>count_cbc</td>
      <td>count_cardiac</td>
      <td>0.626</td>
    </tr>
    <tr>
      <th>0</th>
      <td>num_labs</td>
      <td>lab_time_span_hours</td>
      <td>0.614</td>
    </tr>
    <tr>
      <th>18</th>
      <td>count_liver</td>
      <td>count_cardiac</td>
      <td>0.611</td>
    </tr>
    <tr>
      <th>9</th>
      <td>unique_examination_groups</td>
      <td>unique_analysis_batches</td>
      <td>0.600</td>
    </tr>
    <tr>
      <th>15</th>
      <td>max_gas_pCO2</td>
      <td>max_gas_base excess</td>
      <td>0.588</td>
    </tr>
    <tr>
      <th>11</th>
      <td>unique_analysis_batches</td>
      <td>count_cbc</td>
      <td>0.581</td>
    </tr>
    <tr>
      <th>17</th>
      <td>count_blood_gas</td>
      <td>count_cardiac</td>
      <td>0.557</td>
    </tr>
    <tr>
      <th>2</th>
      <td>num_labs</td>
      <td>unique_analysis_batches</td>
      <td>0.538</td>
    </tr>
    <tr>
      <th>5</th>
      <td>lab_time_span_hours</td>
      <td>unique_examination_groups</td>
      <td>0.537</td>
    </tr>
    <tr>
      <th>13</th>
      <td>max_blood_anion gap</td>
      <td>max_blood_urea nitrogen</td>
      <td>0.534</td>
    </tr>
    <tr>
      <th>10</th>
      <td>fluid_diversity</td>
      <td>unique_analysis_batches</td>
      <td>0.524</td>
    </tr>
    <tr>
      <th>7</th>
      <td>unique_lab_tests</td>
      <td>count_cbc</td>
      <td>0.523</td>
    </tr>
    <tr>
      <th>12</th>
      <td>max_blood_anion gap</td>
      <td>max_blood_creatinine</td>
      <td>0.520</td>
    </tr>
    <tr>
      <th>1</th>
      <td>num_labs</td>
      <td>unique_lab_tests</td>
      <td>0.505</td>
    </tr>
  </tbody>
</table>
</div>



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_98_4.png)
    



```python
len(feat.columns), feat.columns
```




    (34,
     Index(['subject_id', 'hadm_id', 'num_labs', 'abnormal_ratio', 'qc_fail_ratio',
            'lab_time_span_hours', 'unique_lab_tests', 'unique_examination_groups',
            'fluid_diversity', 'unique_analysis_batches', 'max_blood_glucose',
            'max_blood_lactate', 'max_blood_anion gap', 'max_blood_creatinine',
            'max_blood_urea nitrogen', 'max_blood_potassium', 'max_blood_sodium',
            'min_blood_hemoglobin', 'min_blood_hematocrit',
            'max_blood_c-reactive protein', 'max_urine_glucose',
            'max_urine_creatinine', 'max_urine_urea nitrogen', 'max_urine_sodium',
            'max_urine_protein', 'max_gas_pO2', 'max_gas_pCO2', 'max_gas_pH',
            'max_gas_base excess', 'count_cbc', 'count_blood_gas', 'count_liver',
            'count_cardiac', 'has_labs'],
           dtype='object'))




```python
# Keep identifiers + common aggregates, and include all min_/max_ lab vars automatically
base_keep = [
    'subject_id', 'hadm_id',
    'num_labs',
    'abnormal_ratio',
    'qc_fail_ratio',
    'lab_time_span_hours', 'unique_lab_tests',
    'unique_examination_groups',
    'fluid_diversity', 'unique_analysis_batches',
    'has_labs'
]

# automatically include any min_ or max_ columns produced by feat_labs aggregation
minmax_cols = [c for c in feat.columns if c.startswith('min_') or c.startswith('max_') or c.startswith('count_')] 

features_to_keep = base_keep + minmax_cols

# Filter to only keep columns that exist in feat (defensive)
features_to_keep = [col for col in features_to_keep if col in feat.columns]

feat_reduced = feat[features_to_keep]

print(f"Reduced from {len(feat.columns)} to {len(feat_reduced.columns)} columns (kept {len(minmax_cols)} min/max cols)")
feat_reduced.columns
```

    Reduced from 34 to 34 columns (kept 23 min/max cols)
    




    Index(['subject_id', 'hadm_id', 'num_labs', 'abnormal_ratio', 'qc_fail_ratio',
           'lab_time_span_hours', 'unique_lab_tests', 'unique_examination_groups',
           'fluid_diversity', 'unique_analysis_batches', 'has_labs',
           'max_blood_glucose', 'max_blood_lactate', 'max_blood_anion gap',
           'max_blood_creatinine', 'max_blood_urea nitrogen',
           'max_blood_potassium', 'max_blood_sodium', 'min_blood_hemoglobin',
           'min_blood_hematocrit', 'max_blood_c-reactive protein',
           'max_urine_glucose', 'max_urine_creatinine', 'max_urine_urea nitrogen',
           'max_urine_sodium', 'max_urine_protein', 'max_gas_pO2', 'max_gas_pCO2',
           'max_gas_pH', 'max_gas_base excess', 'count_cbc', 'count_blood_gas',
           'count_liver', 'count_cardiac'],
          dtype='object')




```python
# Index(['subject_id', 'hadm_id', 'num_labs', 'abnormal_ratio', 'qc_fail_ratio',
#        'lab_time_span_hours', 'unique_lab_tests', 'has_labs',
#        'max_blood_glucose', 'max_blood_lactate', 'max_blood_anion gap',
#        'max_blood_creatinine', 'max_blood_urea nitrogen',
#        'max_blood_potassium', 'max_blood_sodium', 'min_blood_hemoglobin',
#        'min_blood_hematocrit', 'max_blood_c-reactive protein',
#        'max_urine_glucose', 'max_urine_creatinine', 'max_urine_urea nitrogen',
#        'max_urine_sodium', 'max_urine_protein', 'max_gas_pO2', 'max_gas_pCO2',
#        'max_gas_pH', 'max_gas_base excess'],
```


```python
feat_reduced.to_csv(f"{DATA_DIR}/{DATASETS[name].replace('.csv', '_agg_features_large.csv')}", index=False)
```


```python
DATA_DIR, DATASETS[name].replace('.csv', '_agg_features_large.csv')
```




    ('Y:\\Studium\\3. Sem UniPI\\Data Analytics 4 digital Health\\Data',
     'laboratory_events_codes_2_agg_features_large.csv')



## Save SLim


```python
feat_reduced.to_csv(f"{DATA_DIR}/{DATASETS[name].replace('.csv', '_agg_features.csv')}", index=False)
```


```python
DATA_DIR
```




    'Y:\\Studium\\3. Sem UniPI\\Data Analytics 4 digital Health\\Data'




```python
feat_reduced.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>subject_id</th>
      <th>hadm_id</th>
      <th>num_labs</th>
      <th>abnormal_ratio</th>
      <th>qc_fail_ratio</th>
      <th>lab_time_span_hours</th>
      <th>unique_lab_tests</th>
      <th>unique_examination_groups</th>
      <th>fluid_diversity</th>
      <th>unique_analysis_batches</th>
      <th>...</th>
      <th>max_urine_sodium</th>
      <th>max_urine_protein</th>
      <th>max_gas_pO2</th>
      <th>max_gas_pCO2</th>
      <th>max_gas_pH</th>
      <th>max_gas_base excess</th>
      <th>count_cbc</th>
      <th>count_blood_gas</th>
      <th>count_liver</th>
      <th>count_cardiac</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>4.855000e+03</td>
      <td>4.855000e+03</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
      <td>...</td>
      <td>676.000000</td>
      <td>903.000000</td>
      <td>1202.000000</td>
      <td>1197.000000</td>
      <td>4713.000000</td>
      <td>1203.000000</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
      <td>4855.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1.510805e+07</td>
      <td>2.501709e+07</td>
      <td>240.493306</td>
      <td>0.000086</td>
      <td>0.020154</td>
      <td>115.134343</td>
      <td>47.647168</td>
      <td>9.218332</td>
      <td>1.552626</td>
      <td>119.398764</td>
      <td>...</td>
      <td>57.590237</td>
      <td>85.225692</td>
      <td>26.367305</td>
      <td>6.441000</td>
      <td>59.284682</td>
      <td>2.929343</td>
      <td>69.267971</td>
      <td>23.490834</td>
      <td>5.736972</td>
      <td>7.646344</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2.939544e+06</td>
      <td>2.874953e+06</td>
      <td>513.277369</td>
      <td>0.000800</td>
      <td>0.014587</td>
      <td>111.872999</td>
      <td>21.559055</td>
      <td>5.192832</td>
      <td>0.645785</td>
      <td>72.279992</td>
      <td>...</td>
      <td>33.727525</td>
      <td>113.275414</td>
      <td>18.725899</td>
      <td>1.798151</td>
      <td>105.428314</td>
      <td>5.146037</td>
      <td>121.124737</td>
      <td>164.087887</td>
      <td>20.387880</td>
      <td>9.589104</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000098e+07</td>
      <td>2.000446e+07</td>
      <td>3.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>3.000000</td>
      <td>...</td>
      <td>10.000000</td>
      <td>0.100000</td>
      <td>2.261000</td>
      <td>3.059000</td>
      <td>0.516800</td>
      <td>-15.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.251722e+07</td>
      <td>2.260072e+07</td>
      <td>79.000000</td>
      <td>0.000000</td>
      <td>0.011236</td>
      <td>44.233333</td>
      <td>31.000000</td>
      <td>6.000000</td>
      <td>1.000000</td>
      <td>67.000000</td>
      <td>...</td>
      <td>29.000000</td>
      <td>30.000000</td>
      <td>10.640000</td>
      <td>5.320000</td>
      <td>1.356600</td>
      <td>0.000000</td>
      <td>27.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1.507734e+07</td>
      <td>2.503202e+07</td>
      <td>136.000000</td>
      <td>0.000000</td>
      <td>0.019002</td>
      <td>81.100000</td>
      <td>43.000000</td>
      <td>8.000000</td>
      <td>1.000000</td>
      <td>103.000000</td>
      <td>...</td>
      <td>54.000000</td>
      <td>30.000000</td>
      <td>19.152000</td>
      <td>6.118000</td>
      <td>60.200000</td>
      <td>2.000000</td>
      <td>42.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>6.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.765293e+07</td>
      <td>2.746949e+07</td>
      <td>259.000000</td>
      <td>0.000000</td>
      <td>0.027141</td>
      <td>149.150000</td>
      <td>60.000000</td>
      <td>11.000000</td>
      <td>2.000000</td>
      <td>158.000000</td>
      <td>...</td>
      <td>81.000000</td>
      <td>100.000000</td>
      <td>43.191750</td>
      <td>7.182000</td>
      <td>85.000000</td>
      <td>5.000000</td>
      <td>80.000000</td>
      <td>6.000000</td>
      <td>5.000000</td>
      <td>10.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1.999860e+07</td>
      <td>2.999967e+07</td>
      <td>22580.000000</td>
      <td>0.019802</td>
      <td>0.285714</td>
      <td>1257.800000</td>
      <td>175.000000</td>
      <td>54.000000</td>
      <td>5.000000</td>
      <td>543.000000</td>
      <td>...</td>
      <td>212.000000</td>
      <td>660.000000</td>
      <td>73.017000</td>
      <td>19.152000</td>
      <td>3825.000000</td>
      <td>33.000000</td>
      <td>4840.000000</td>
      <td>8875.000000</td>
      <td>910.000000</td>
      <td>240.000000</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 34 columns</p>
</div>



## Check new vars for distr (box plots) => outliers, etc


```python
import os
import matplotlib.pyplot as plt
import seaborn as sns
from scipy import stats

numeric_cols = [c for c in feat_reduced.select_dtypes(include=[np.number]).columns if c not in ('subject_id','hadm_id')]
print("Numeric features:", numeric_cols)

# Summary table with percentiles and outlier thresholds
summary = []
for c in numeric_cols:
    s = feat_reduced[c].dropna()
    q1, q3 = s.quantile(0.25), s.quantile(0.75)
    iqr = q3 - q1
    lower_th = q1 - 1.5 * iqr
    upper_th = q3 + 1.5 * iqr
    p01, p99 = s.quantile(0.01), s.quantile(0.99)
    n = len(s)
    n_out = ((s < lower_th) | (s > upper_th)).sum()
    summary.append((c, n, s.min(), s.median(), s.max(), q1, q3, iqr, lower_th, upper_th, p01, p99, n_out, n_out / max(1,n)))
summary_df = pd.DataFrame(summary, columns=[
    'feature','n','min','median','max','q1','q3','iqr','lower_th','upper_th','p01','p99','n_outliers','frac_outliers'])
display(summary_df.sort_values('frac_outliers', ascending=False))

# Plot each feature: histogram + boxplot (compact)
plots_dir = os.path.join(os.path.abspath('.'), 'plots')
os.makedirs(plots_dir, exist_ok=True)
for c in numeric_cols:
    s = feat_reduced[c]
    fig, axes = plt.subplots(1,2, figsize=(12,3))
    sns.histplot(s.dropna(), bins=40, ax=axes[0], kde=False)
    axes[0].set_title(f"{c} — hist")
    sns.boxplot(x=s.dropna(), ax=axes[1], orient='h')
    axes[1].set_title(f"{c} — box")
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, f"dist_{c}.png"), dpi=120, bbox_inches='tight')
    plt.show()

# Winsorization helper (in-place on copy)
def winsorize_df(df, cols, lower_pct=0.01, upper_pct=0.99):
    out = df.copy()
    for c in cols:
        if c not in out.columns: 
            continue
        lower = out[c].quantile(lower_pct)
        upper = out[c].quantile(upper_pct)
        out[c] = out[c].clip(lower=lower, upper=upper)
    return out

# Create winsorized version and compare summaries for a few features
feat_wins = winsorize_df(feat_reduced, numeric_cols, lower_pct=0.01, upper_pct=0.99)
comp = pd.concat([feat_reduced[numeric_cols].describe().T[['mean','std','min','25%','50%','75%','max']],
                  feat_wins[numeric_cols].describe().T[['mean','std','min','25%','50%','75%','max']]],
                 axis=1, keys=['orig','wins'])
display(comp)

# small visual comparison for top 6 features with most outliers
top = summary_df.sort_values('n_outliers', ascending=False).head(6)['feature'].tolist()
for c in top:
    fig, axes = plt.subplots(1,2, figsize=(10,3))
    sns.boxplot(x=feat_reduced[c].dropna(), ax=axes[0], orient='h').set_title(f"{c} orig")
    sns.boxplot(x=feat_wins[c].dropna(), ax=axes[1], orient='h').set_title(f"{c} winsorized (1/99)")
    plt.tight_layout(); plt.show()

# Print instructions summary
print("\nNotes:\n- Review 'n_outliers' and 'frac_outliers' in summary_df to decide aggressiveness.\n- Adjust winsorize_df lower_pct/upper_pct (e.g., 0.005/0.995) or use IQR-based clipping using lower_th/upper_th.")
```

    Numeric features: ['num_labs', 'abnormal_ratio', 'qc_fail_ratio', 'lab_time_span_hours', 'unique_lab_tests', 'unique_examination_groups', 'fluid_diversity', 'unique_analysis_batches', 'has_labs', 'max_blood_glucose', 'max_blood_lactate', 'max_blood_anion gap', 'max_blood_creatinine', 'max_blood_urea nitrogen', 'max_blood_potassium', 'max_blood_sodium', 'min_blood_hemoglobin', 'min_blood_hematocrit', 'max_blood_c-reactive protein', 'max_urine_glucose', 'max_urine_creatinine', 'max_urine_urea nitrogen', 'max_urine_sodium', 'max_urine_protein', 'max_gas_pO2', 'max_gas_pCO2', 'max_gas_pH', 'max_gas_base excess', 'count_cbc', 'count_blood_gas', 'count_liver', 'count_cardiac']
    


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature</th>
      <th>n</th>
      <th>min</th>
      <th>median</th>
      <th>max</th>
      <th>q1</th>
      <th>q3</th>
      <th>iqr</th>
      <th>lower_th</th>
      <th>upper_th</th>
      <th>p01</th>
      <th>p99</th>
      <th>n_outliers</th>
      <th>frac_outliers</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>29</th>
      <td>count_blood_gas</td>
      <td>4855</td>
      <td>0.0000</td>
      <td>0.000000</td>
      <td>8875.000000</td>
      <td>0.000000</td>
      <td>6.000000</td>
      <td>6.000000</td>
      <td>-9.000000</td>
      <td>15.000000</td>
      <td>0.0000</td>
      <td>368.000000</td>
      <td>817</td>
      <td>0.168280</td>
    </tr>
    <tr>
      <th>23</th>
      <td>max_urine_protein</td>
      <td>903</td>
      <td>0.1000</td>
      <td>30.000000</td>
      <td>660.000000</td>
      <td>30.000000</td>
      <td>100.000000</td>
      <td>70.000000</td>
      <td>-75.000000</td>
      <td>205.000000</td>
      <td>6.0000</td>
      <td>586.240000</td>
      <td>100</td>
      <td>0.110742</td>
    </tr>
    <tr>
      <th>12</th>
      <td>max_blood_creatinine</td>
      <td>4835</td>
      <td>17.6800</td>
      <td>106.080000</td>
      <td>1608.880000</td>
      <td>88.400000</td>
      <td>159.120000</td>
      <td>70.720000</td>
      <td>-17.680000</td>
      <td>265.200000</td>
      <td>53.0400</td>
      <td>822.120000</td>
      <td>516</td>
      <td>0.106722</td>
    </tr>
    <tr>
      <th>30</th>
      <td>count_liver</td>
      <td>4855</td>
      <td>0.0000</td>
      <td>0.000000</td>
      <td>910.000000</td>
      <td>0.000000</td>
      <td>5.000000</td>
      <td>5.000000</td>
      <td>-7.500000</td>
      <td>12.500000</td>
      <td>0.0000</td>
      <td>58.920000</td>
      <td>504</td>
      <td>0.103811</td>
    </tr>
    <tr>
      <th>0</th>
      <td>num_labs</td>
      <td>4855</td>
      <td>3.0000</td>
      <td>136.000000</td>
      <td>22580.000000</td>
      <td>79.000000</td>
      <td>259.000000</td>
      <td>180.000000</td>
      <td>-191.000000</td>
      <td>529.000000</td>
      <td>23.0000</td>
      <td>1520.000000</td>
      <td>380</td>
      <td>0.078270</td>
    </tr>
    <tr>
      <th>28</th>
      <td>count_cbc</td>
      <td>4855</td>
      <td>0.0000</td>
      <td>42.000000</td>
      <td>4840.000000</td>
      <td>27.000000</td>
      <td>80.000000</td>
      <td>53.000000</td>
      <td>-52.500000</td>
      <td>159.500000</td>
      <td>9.0000</td>
      <td>421.380000</td>
      <td>365</td>
      <td>0.075180</td>
    </tr>
    <tr>
      <th>13</th>
      <td>max_blood_urea nitrogen</td>
      <td>4835</td>
      <td>1.4280</td>
      <td>9.639000</td>
      <td>73.899000</td>
      <td>6.783000</td>
      <td>15.529500</td>
      <td>8.746500</td>
      <td>-6.336750</td>
      <td>28.649250</td>
      <td>3.2130</td>
      <td>44.625000</td>
      <td>316</td>
      <td>0.065357</td>
    </tr>
    <tr>
      <th>27</th>
      <td>max_gas_base excess</td>
      <td>1203</td>
      <td>-15.0000</td>
      <td>2.000000</td>
      <td>33.000000</td>
      <td>0.000000</td>
      <td>5.000000</td>
      <td>5.000000</td>
      <td>-7.500000</td>
      <td>12.500000</td>
      <td>-7.9800</td>
      <td>18.980000</td>
      <td>75</td>
      <td>0.062344</td>
    </tr>
    <tr>
      <th>3</th>
      <td>lab_time_span_hours</td>
      <td>4855</td>
      <td>0.0000</td>
      <td>81.100000</td>
      <td>1257.800000</td>
      <td>44.233333</td>
      <td>149.150000</td>
      <td>104.916667</td>
      <td>-113.141667</td>
      <td>306.525000</td>
      <td>0.0000</td>
      <td>514.624333</td>
      <td>301</td>
      <td>0.061998</td>
    </tr>
    <tr>
      <th>31</th>
      <td>count_cardiac</td>
      <td>4855</td>
      <td>0.0000</td>
      <td>6.000000</td>
      <td>240.000000</td>
      <td>3.000000</td>
      <td>10.000000</td>
      <td>7.000000</td>
      <td>-7.500000</td>
      <td>20.500000</td>
      <td>0.0000</td>
      <td>41.000000</td>
      <td>285</td>
      <td>0.058702</td>
    </tr>
    <tr>
      <th>9</th>
      <td>max_blood_glucose</td>
      <td>4822</td>
      <td>2.5530</td>
      <td>8.158500</td>
      <td>49.950000</td>
      <td>6.327000</td>
      <td>10.933500</td>
      <td>4.606500</td>
      <td>-0.582750</td>
      <td>17.843250</td>
      <td>4.6065</td>
      <td>26.283690</td>
      <td>282</td>
      <td>0.058482</td>
    </tr>
    <tr>
      <th>14</th>
      <td>max_blood_potassium</td>
      <td>4838</td>
      <td>1.6000</td>
      <td>4.600000</td>
      <td>9.500000</td>
      <td>4.300000</td>
      <td>4.900000</td>
      <td>0.600000</td>
      <td>3.400000</td>
      <td>5.800000</td>
      <td>3.6000</td>
      <td>6.963000</td>
      <td>277</td>
      <td>0.057255</td>
    </tr>
    <tr>
      <th>20</th>
      <td>max_urine_creatinine</td>
      <td>805</td>
      <td>0.5000</td>
      <td>79.000000</td>
      <td>4757.500000</td>
      <td>46.000000</td>
      <td>128.000000</td>
      <td>82.000000</td>
      <td>-77.000000</td>
      <td>251.000000</td>
      <td>9.0000</td>
      <td>1451.440000</td>
      <td>44</td>
      <td>0.054658</td>
    </tr>
    <tr>
      <th>5</th>
      <td>unique_examination_groups</td>
      <td>4855</td>
      <td>1.0000</td>
      <td>8.000000</td>
      <td>54.000000</td>
      <td>6.000000</td>
      <td>11.000000</td>
      <td>5.000000</td>
      <td>-1.500000</td>
      <td>18.500000</td>
      <td>4.0000</td>
      <td>30.000000</td>
      <td>263</td>
      <td>0.054171</td>
    </tr>
    <tr>
      <th>10</th>
      <td>max_blood_lactate</td>
      <td>2011</td>
      <td>0.6000</td>
      <td>208.000000</td>
      <td>28570.000000</td>
      <td>2.500000</td>
      <td>302.000000</td>
      <td>299.500000</td>
      <td>-446.750000</td>
      <td>751.250000</td>
      <td>0.8000</td>
      <td>2714.900000</td>
      <td>96</td>
      <td>0.047737</td>
    </tr>
    <tr>
      <th>25</th>
      <td>max_gas_pCO2</td>
      <td>1197</td>
      <td>3.0590</td>
      <td>6.118000</td>
      <td>19.152000</td>
      <td>5.320000</td>
      <td>7.182000</td>
      <td>1.862000</td>
      <td>2.527000</td>
      <td>9.975000</td>
      <td>3.5910</td>
      <td>12.768000</td>
      <td>52</td>
      <td>0.043442</td>
    </tr>
    <tr>
      <th>18</th>
      <td>max_blood_c-reactive protein</td>
      <td>233</td>
      <td>0.3000</td>
      <td>53.800000</td>
      <td>294.900000</td>
      <td>13.800000</td>
      <td>113.400000</td>
      <td>99.600000</td>
      <td>-135.600000</td>
      <td>262.800000</td>
      <td>0.6640</td>
      <td>272.812000</td>
      <td>8</td>
      <td>0.034335</td>
    </tr>
    <tr>
      <th>7</th>
      <td>unique_analysis_batches</td>
      <td>4855</td>
      <td>3.0000</td>
      <td>103.000000</td>
      <td>543.000000</td>
      <td>67.000000</td>
      <td>158.000000</td>
      <td>91.000000</td>
      <td>-69.500000</td>
      <td>294.500000</td>
      <td>21.0000</td>
      <td>368.460000</td>
      <td>142</td>
      <td>0.029248</td>
    </tr>
    <tr>
      <th>11</th>
      <td>max_blood_anion gap</td>
      <td>4824</td>
      <td>6.0000</td>
      <td>16.000000</td>
      <td>53.000000</td>
      <td>14.000000</td>
      <td>18.000000</td>
      <td>4.000000</td>
      <td>8.000000</td>
      <td>24.000000</td>
      <td>10.0000</td>
      <td>28.000000</td>
      <td>135</td>
      <td>0.027985</td>
    </tr>
    <tr>
      <th>2</th>
      <td>qc_fail_ratio</td>
      <td>4855</td>
      <td>0.0000</td>
      <td>0.019002</td>
      <td>0.285714</td>
      <td>0.011236</td>
      <td>0.027141</td>
      <td>0.015905</td>
      <td>-0.012621</td>
      <td>0.050997</td>
      <td>0.0000</td>
      <td>0.065217</td>
      <td>132</td>
      <td>0.027188</td>
    </tr>
    <tr>
      <th>21</th>
      <td>max_urine_urea nitrogen</td>
      <td>629</td>
      <td>72.0000</td>
      <td>498.000000</td>
      <td>1612.000000</td>
      <td>319.000000</td>
      <td>685.000000</td>
      <td>366.000000</td>
      <td>-230.000000</td>
      <td>1234.000000</td>
      <td>102.9600</td>
      <td>1426.960000</td>
      <td>17</td>
      <td>0.027027</td>
    </tr>
    <tr>
      <th>26</th>
      <td>max_gas_pH</td>
      <td>4713</td>
      <td>0.5168</td>
      <td>60.200000</td>
      <td>3825.000000</td>
      <td>1.356600</td>
      <td>85.000000</td>
      <td>83.643400</td>
      <td>-124.108500</td>
      <td>210.465100</td>
      <td>0.8398</td>
      <td>305.520000</td>
      <td>114</td>
      <td>0.024188</td>
    </tr>
    <tr>
      <th>15</th>
      <td>max_blood_sodium</td>
      <td>4827</td>
      <td>97.0000</td>
      <td>141.000000</td>
      <td>175.000000</td>
      <td>139.000000</td>
      <td>143.000000</td>
      <td>4.000000</td>
      <td>133.000000</td>
      <td>149.000000</td>
      <td>132.0000</td>
      <td>150.000000</td>
      <td>112</td>
      <td>0.023203</td>
    </tr>
    <tr>
      <th>1</th>
      <td>abnormal_ratio</td>
      <td>4855</td>
      <td>0.0000</td>
      <td>0.000000</td>
      <td>0.019802</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.0000</td>
      <td>0.003513</td>
      <td>86</td>
      <td>0.017714</td>
    </tr>
    <tr>
      <th>6</th>
      <td>fluid_diversity</td>
      <td>4855</td>
      <td>1.0000</td>
      <td>1.000000</td>
      <td>5.000000</td>
      <td>1.000000</td>
      <td>2.000000</td>
      <td>1.000000</td>
      <td>-0.500000</td>
      <td>3.500000</td>
      <td>1.0000</td>
      <td>4.000000</td>
      <td>82</td>
      <td>0.016890</td>
    </tr>
    <tr>
      <th>4</th>
      <td>unique_lab_tests</td>
      <td>4855</td>
      <td>3.0000</td>
      <td>43.000000</td>
      <td>175.000000</td>
      <td>31.000000</td>
      <td>60.000000</td>
      <td>29.000000</td>
      <td>-12.500000</td>
      <td>103.500000</td>
      <td>20.0000</td>
      <td>113.000000</td>
      <td>78</td>
      <td>0.016066</td>
    </tr>
    <tr>
      <th>22</th>
      <td>max_urine_sodium</td>
      <td>676</td>
      <td>10.0000</td>
      <td>54.000000</td>
      <td>212.000000</td>
      <td>29.000000</td>
      <td>81.000000</td>
      <td>52.000000</td>
      <td>-49.000000</td>
      <td>159.000000</td>
      <td>11.0000</td>
      <td>148.500000</td>
      <td>5</td>
      <td>0.007396</td>
    </tr>
    <tr>
      <th>19</th>
      <td>max_urine_glucose</td>
      <td>208</td>
      <td>3.8850</td>
      <td>13.875000</td>
      <td>727.000000</td>
      <td>5.550000</td>
      <td>55.500000</td>
      <td>49.950000</td>
      <td>-69.375000</td>
      <td>130.425000</td>
      <td>3.8850</td>
      <td>55.500000</td>
      <td>1</td>
      <td>0.004808</td>
    </tr>
    <tr>
      <th>17</th>
      <td>min_blood_hematocrit</td>
      <td>4825</td>
      <td>0.0000</td>
      <td>32.900000</td>
      <td>55.000000</td>
      <td>28.100000</td>
      <td>37.300000</td>
      <td>9.200000</td>
      <td>14.300000</td>
      <td>51.100000</td>
      <td>19.0000</td>
      <td>46.400000</td>
      <td>15</td>
      <td>0.003109</td>
    </tr>
    <tr>
      <th>8</th>
      <td>has_labs</td>
      <td>4855</td>
      <td>1.0000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.0000</td>
      <td>1.000000</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>min_blood_hemoglobin</td>
      <td>4807</td>
      <td>0.0000</td>
      <td>99.000000</td>
      <td>182.000000</td>
      <td>71.000000</td>
      <td>119.000000</td>
      <td>48.000000</td>
      <td>-1.000000</td>
      <td>191.000000</td>
      <td>4.8000</td>
      <td>155.000000</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>24</th>
      <td>max_gas_pO2</td>
      <td>1202</td>
      <td>2.2610</td>
      <td>19.152000</td>
      <td>73.017000</td>
      <td>10.640000</td>
      <td>43.191750</td>
      <td>32.551750</td>
      <td>-38.187625</td>
      <td>92.019375</td>
      <td>3.9900</td>
      <td>67.431000</td>
      <td>0</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_2.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_3.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_4.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_5.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_6.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_7.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_8.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_9.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_10.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_11.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_12.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_13.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_14.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_15.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_16.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_17.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_18.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_19.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_20.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_21.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_22.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_23.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_24.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_25.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_26.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_27.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_28.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_29.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_30.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_31.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_32.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_33.png)
    



<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="7" halign="left">orig</th>
      <th colspan="7" halign="left">wins</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>num_labs</th>
      <td>240.493306</td>
      <td>513.277369</td>
      <td>3.0000</td>
      <td>79.000000</td>
      <td>136.000000</td>
      <td>259.000000</td>
      <td>22580.000000</td>
      <td>220.828630</td>
      <td>248.977076</td>
      <td>23.0000</td>
      <td>79.000000</td>
      <td>136.000000</td>
      <td>259.000000</td>
      <td>1520.000000</td>
    </tr>
    <tr>
      <th>abnormal_ratio</th>
      <td>0.000086</td>
      <td>0.000800</td>
      <td>0.0000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.019802</td>
      <td>0.000052</td>
      <td>0.000401</td>
      <td>0.0000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.003513</td>
    </tr>
    <tr>
      <th>qc_fail_ratio</th>
      <td>0.020154</td>
      <td>0.014587</td>
      <td>0.0000</td>
      <td>0.011236</td>
      <td>0.019002</td>
      <td>0.027141</td>
      <td>0.285714</td>
      <td>0.019969</td>
      <td>0.013497</td>
      <td>0.0000</td>
      <td>0.011236</td>
      <td>0.019002</td>
      <td>0.027141</td>
      <td>0.065217</td>
    </tr>
    <tr>
      <th>lab_time_span_hours</th>
      <td>115.134343</td>
      <td>111.872999</td>
      <td>0.0000</td>
      <td>44.233333</td>
      <td>81.100000</td>
      <td>149.150000</td>
      <td>1257.800000</td>
      <td>113.253455</td>
      <td>101.605142</td>
      <td>0.0000</td>
      <td>44.233333</td>
      <td>81.100000</td>
      <td>149.150000</td>
      <td>514.624333</td>
    </tr>
    <tr>
      <th>unique_lab_tests</th>
      <td>47.647168</td>
      <td>21.559055</td>
      <td>3.0000</td>
      <td>31.000000</td>
      <td>43.000000</td>
      <td>60.000000</td>
      <td>175.000000</td>
      <td>47.567662</td>
      <td>20.947772</td>
      <td>20.0000</td>
      <td>31.000000</td>
      <td>43.000000</td>
      <td>60.000000</td>
      <td>113.000000</td>
    </tr>
    <tr>
      <th>unique_examination_groups</th>
      <td>9.218332</td>
      <td>5.192832</td>
      <td>1.0000</td>
      <td>6.000000</td>
      <td>8.000000</td>
      <td>11.000000</td>
      <td>54.000000</td>
      <td>9.163131</td>
      <td>4.830092</td>
      <td>4.0000</td>
      <td>6.000000</td>
      <td>8.000000</td>
      <td>11.000000</td>
      <td>30.000000</td>
    </tr>
    <tr>
      <th>fluid_diversity</th>
      <td>1.552626</td>
      <td>0.645785</td>
      <td>1.0000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>2.000000</td>
      <td>5.000000</td>
      <td>1.552008</td>
      <td>0.642958</td>
      <td>1.0000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>2.000000</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>unique_analysis_batches</th>
      <td>119.398764</td>
      <td>72.279992</td>
      <td>3.0000</td>
      <td>67.000000</td>
      <td>103.000000</td>
      <td>158.000000</td>
      <td>543.000000</td>
      <td>118.959740</td>
      <td>70.159342</td>
      <td>21.0000</td>
      <td>67.000000</td>
      <td>103.000000</td>
      <td>158.000000</td>
      <td>368.460000</td>
    </tr>
    <tr>
      <th>has_labs</th>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>1.0000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>1.0000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>max_blood_glucose</th>
      <td>9.478116</td>
      <td>4.675858</td>
      <td>2.5530</td>
      <td>6.327000</td>
      <td>8.158500</td>
      <td>10.933500</td>
      <td>49.950000</td>
      <td>9.415818</td>
      <td>4.329545</td>
      <td>4.6065</td>
      <td>6.327000</td>
      <td>8.158500</td>
      <td>10.933500</td>
      <td>26.283690</td>
    </tr>
    <tr>
      <th>max_blood_lactate</th>
      <td>305.981303</td>
      <td>968.892698</td>
      <td>0.6000</td>
      <td>2.500000</td>
      <td>208.000000</td>
      <td>302.000000</td>
      <td>28570.000000</td>
      <td>254.357185</td>
      <td>367.897494</td>
      <td>0.8000</td>
      <td>2.500000</td>
      <td>208.000000</td>
      <td>302.000000</td>
      <td>2714.900000</td>
    </tr>
    <tr>
      <th>max_blood_anion gap</th>
      <td>16.608002</td>
      <td>3.611089</td>
      <td>6.0000</td>
      <td>14.000000</td>
      <td>16.000000</td>
      <td>18.000000</td>
      <td>53.000000</td>
      <td>16.579395</td>
      <td>3.417994</td>
      <td>10.0000</td>
      <td>14.000000</td>
      <td>16.000000</td>
      <td>18.000000</td>
      <td>28.000000</td>
    </tr>
    <tr>
      <th>max_blood_creatinine</th>
      <td>155.059268</td>
      <td>145.564017</td>
      <td>17.6800</td>
      <td>88.400000</td>
      <td>106.080000</td>
      <td>159.120000</td>
      <td>1608.880000</td>
      <td>153.196194</td>
      <td>133.275563</td>
      <td>53.0400</td>
      <td>88.400000</td>
      <td>106.080000</td>
      <td>159.120000</td>
      <td>822.120000</td>
    </tr>
    <tr>
      <th>max_blood_urea nitrogen</th>
      <td>12.572307</td>
      <td>8.860879</td>
      <td>1.4280</td>
      <td>6.783000</td>
      <td>9.639000</td>
      <td>15.529500</td>
      <td>73.899000</td>
      <td>12.497141</td>
      <td>8.499513</td>
      <td>3.2130</td>
      <td>6.783000</td>
      <td>9.639000</td>
      <td>15.529500</td>
      <td>44.625000</td>
    </tr>
    <tr>
      <th>max_blood_potassium</th>
      <td>4.683743</td>
      <td>0.654319</td>
      <td>1.6000</td>
      <td>4.300000</td>
      <td>4.600000</td>
      <td>4.900000</td>
      <td>9.500000</td>
      <td>4.678532</td>
      <td>0.617447</td>
      <td>3.6000</td>
      <td>4.300000</td>
      <td>4.600000</td>
      <td>4.900000</td>
      <td>6.963000</td>
    </tr>
    <tr>
      <th>max_blood_sodium</th>
      <td>141.015745</td>
      <td>3.430767</td>
      <td>97.0000</td>
      <td>139.000000</td>
      <td>141.000000</td>
      <td>143.000000</td>
      <td>175.000000</td>
      <td>141.015745</td>
      <td>3.158436</td>
      <td>132.0000</td>
      <td>139.000000</td>
      <td>141.000000</td>
      <td>143.000000</td>
      <td>150.000000</td>
    </tr>
    <tr>
      <th>min_blood_hemoglobin</th>
      <td>85.369960</td>
      <td>46.324267</td>
      <td>0.0000</td>
      <td>71.000000</td>
      <td>99.000000</td>
      <td>119.000000</td>
      <td>182.000000</td>
      <td>85.347015</td>
      <td>46.170374</td>
      <td>4.8000</td>
      <td>71.000000</td>
      <td>99.000000</td>
      <td>119.000000</td>
      <td>155.000000</td>
    </tr>
    <tr>
      <th>min_blood_hematocrit</th>
      <td>32.678073</td>
      <td>6.363201</td>
      <td>0.0000</td>
      <td>28.100000</td>
      <td>32.900000</td>
      <td>37.300000</td>
      <td>55.000000</td>
      <td>32.681368</td>
      <td>6.244364</td>
      <td>19.0000</td>
      <td>28.100000</td>
      <td>32.900000</td>
      <td>37.300000</td>
      <td>46.400000</td>
    </tr>
    <tr>
      <th>max_blood_c-reactive protein</th>
      <td>74.088841</td>
      <td>72.093089</td>
      <td>0.3000</td>
      <td>13.800000</td>
      <td>53.800000</td>
      <td>113.400000</td>
      <td>294.900000</td>
      <td>73.942180</td>
      <td>71.659047</td>
      <td>0.6640</td>
      <td>13.800000</td>
      <td>53.800000</td>
      <td>113.400000</td>
      <td>272.812000</td>
    </tr>
    <tr>
      <th>max_urine_glucose</th>
      <td>25.441707</td>
      <td>53.220730</td>
      <td>3.8850</td>
      <td>5.550000</td>
      <td>13.875000</td>
      <td>55.500000</td>
      <td>727.000000</td>
      <td>22.213341</td>
      <td>21.181064</td>
      <td>3.8850</td>
      <td>5.550000</td>
      <td>13.875000</td>
      <td>55.500000</td>
      <td>55.500000</td>
    </tr>
    <tr>
      <th>max_urine_creatinine</th>
      <td>124.489193</td>
      <td>263.533404</td>
      <td>0.5000</td>
      <td>46.000000</td>
      <td>79.000000</td>
      <td>128.000000</td>
      <td>4757.500000</td>
      <td>115.705292</td>
      <td>171.033998</td>
      <td>9.0000</td>
      <td>46.000000</td>
      <td>79.000000</td>
      <td>128.000000</td>
      <td>1451.440000</td>
    </tr>
    <tr>
      <th>max_urine_urea nitrogen</th>
      <td>534.325914</td>
      <td>285.141244</td>
      <td>72.0000</td>
      <td>319.000000</td>
      <td>498.000000</td>
      <td>685.000000</td>
      <td>1612.000000</td>
      <td>533.738378</td>
      <td>282.286677</td>
      <td>102.9600</td>
      <td>319.000000</td>
      <td>498.000000</td>
      <td>685.000000</td>
      <td>1426.960000</td>
    </tr>
    <tr>
      <th>max_urine_sodium</th>
      <td>57.590237</td>
      <td>33.727525</td>
      <td>10.0000</td>
      <td>29.000000</td>
      <td>54.000000</td>
      <td>81.000000</td>
      <td>212.000000</td>
      <td>57.348373</td>
      <td>32.885046</td>
      <td>11.0000</td>
      <td>29.000000</td>
      <td>54.000000</td>
      <td>81.000000</td>
      <td>148.500000</td>
    </tr>
    <tr>
      <th>max_urine_protein</th>
      <td>85.225692</td>
      <td>113.275414</td>
      <td>0.1000</td>
      <td>30.000000</td>
      <td>30.000000</td>
      <td>100.000000</td>
      <td>660.000000</td>
      <td>85.027796</td>
      <td>112.321555</td>
      <td>6.0000</td>
      <td>30.000000</td>
      <td>30.000000</td>
      <td>100.000000</td>
      <td>586.240000</td>
    </tr>
    <tr>
      <th>max_gas_pO2</th>
      <td>26.367305</td>
      <td>18.725899</td>
      <td>2.2610</td>
      <td>10.640000</td>
      <td>19.152000</td>
      <td>43.191750</td>
      <td>73.017000</td>
      <td>26.357900</td>
      <td>18.684649</td>
      <td>3.9900</td>
      <td>10.640000</td>
      <td>19.152000</td>
      <td>43.191750</td>
      <td>67.431000</td>
    </tr>
    <tr>
      <th>max_gas_pCO2</th>
      <td>6.441000</td>
      <td>1.798151</td>
      <td>3.0590</td>
      <td>5.320000</td>
      <td>6.118000</td>
      <td>7.182000</td>
      <td>19.152000</td>
      <td>6.423333</td>
      <td>1.704409</td>
      <td>3.5910</td>
      <td>5.320000</td>
      <td>6.118000</td>
      <td>7.182000</td>
      <td>12.768000</td>
    </tr>
    <tr>
      <th>max_gas_pH</th>
      <td>59.284682</td>
      <td>105.428314</td>
      <td>0.5168</td>
      <td>1.356600</td>
      <td>60.200000</td>
      <td>85.000000</td>
      <td>3825.000000</td>
      <td>55.418347</td>
      <td>59.149880</td>
      <td>0.8398</td>
      <td>1.356600</td>
      <td>60.200000</td>
      <td>85.000000</td>
      <td>305.520000</td>
    </tr>
    <tr>
      <th>max_gas_base excess</th>
      <td>2.929343</td>
      <td>5.146037</td>
      <td>-15.0000</td>
      <td>0.000000</td>
      <td>2.000000</td>
      <td>5.000000</td>
      <td>33.000000</td>
      <td>2.896093</td>
      <td>4.842098</td>
      <td>-7.9800</td>
      <td>0.000000</td>
      <td>2.000000</td>
      <td>5.000000</td>
      <td>18.980000</td>
    </tr>
    <tr>
      <th>count_cbc</th>
      <td>69.267971</td>
      <td>121.124737</td>
      <td>0.0000</td>
      <td>27.000000</td>
      <td>42.000000</td>
      <td>80.000000</td>
      <td>4840.000000</td>
      <td>65.274072</td>
      <td>67.848509</td>
      <td>9.0000</td>
      <td>27.000000</td>
      <td>42.000000</td>
      <td>80.000000</td>
      <td>421.380000</td>
    </tr>
    <tr>
      <th>count_blood_gas</th>
      <td>23.490834</td>
      <td>164.087887</td>
      <td>0.0000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>6.000000</td>
      <td>8875.000000</td>
      <td>17.590731</td>
      <td>54.054993</td>
      <td>0.0000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>6.000000</td>
      <td>368.000000</td>
    </tr>
    <tr>
      <th>count_liver</th>
      <td>5.736972</td>
      <td>20.387880</td>
      <td>0.0000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>5.000000</td>
      <td>910.000000</td>
      <td>4.964795</td>
      <td>9.411855</td>
      <td>0.0000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>5.000000</td>
      <td>58.920000</td>
    </tr>
    <tr>
      <th>count_cardiac</th>
      <td>7.646344</td>
      <td>9.589104</td>
      <td>0.0000</td>
      <td>3.000000</td>
      <td>6.000000</td>
      <td>10.000000</td>
      <td>240.000000</td>
      <td>7.371576</td>
      <td>7.308208</td>
      <td>0.0000</td>
      <td>3.000000</td>
      <td>6.000000</td>
      <td>10.000000</td>
      <td>41.000000</td>
    </tr>
  </tbody>
</table>
</div>



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_35.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_36.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_37.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_38.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_39.png)
    



    
![png](1.1%20df2%20laboratory_files/1.1%20df2%20laboratory_109_40.png)
    


    
    Notes:
    - Review 'n_outliers' and 'frac_outliers' in summary_df to decide aggressiveness.
    - Adjust winsorize_df lower_pct/upper_pct (e.g., 0.005/0.995) or use IQR-based clipping using lower_th/upper_th.
    


```python

```


```python

```
